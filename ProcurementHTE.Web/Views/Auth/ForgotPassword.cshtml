@model ProcurementHTE.Web.Models.Auth.ForgotPasswordPageViewModel
@{
    ViewData["Title"] = "Lupa Password";
    Layout = "_AuthenticationLayout";
    var activeTab = (Model.ActiveTab ?? "recovery").ToLowerInvariant();
    var devEmailResetCode = ViewBag.DevEmailResetCode as string;
    var devSmsResetCode = ViewBag.DevSmsResetCode as string;
    var emailCooldownSeconds = ViewBag.ForgotEmailCooldown as int? ?? 0;
    var smsCooldownSeconds = ViewBag.ForgotSmsCooldown as int? ?? 0;
}

<div class="mb-4 text-center">
    <h2 class="mb-1">Lupa Password</h2>
    <p class="text-muted">Pilih metode yang paling mudah untuk memulihkan akses akun Anda.</p>
</div>

<ul class="nav nav-pills justify-content-center gap-2 mb-3" id="forgotTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "recovery" ? "active" : string.Empty)" data-bs-toggle="pill" data-bs-target="#tab-recovery" type="button" role="tab" aria-selected="@(activeTab == "recovery" ? "true" : "false")">
            Recovery Code
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "email" ? "active" : string.Empty)" data-bs-toggle="pill" data-bs-target="#tab-email" type="button" role="tab" aria-selected="@(activeTab == "email" ? "true" : "false")">
            Kode via Email
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "sms" ? "active" : string.Empty)" data-bs-toggle="pill" data-bs-target="#tab-sms" type="button" role="tab" aria-selected="@(activeTab == "sms" ? "true" : "false")">
            Kode via SMS
        </button>
    </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade @(activeTab == "recovery" ? "show active" : string.Empty)" id="tab-recovery" role="tabpanel">
        <div class="card shadow-sm equal-card">
            <div class="card-body d-flex flex-column">
                <h5 class="mb-1">Reset Password via Recovery Code</h5>
                <p class="text-muted">Gunakan recovery code 2FA yang sudah Anda simpan sebelumnya.</p>
                <form asp-action="ResetPasswordWithRecovery" method="post" class="mt-3 d-flex flex-column gap-3 flex-grow-1">
                    <div asp-validation-summary="ModelOnly" class="text-danger small"></div>
                    <div>
                        <label asp-for="Recovery.Identifier" class="form-label"></label>
                        <input asp-for="Recovery.Identifier" class="form-control" />
                        <span asp-validation-for="Recovery.Identifier" class="text-danger small"></span>
                    </div>
                    <div>
                        <label asp-for="Recovery.RecoveryCode" class="form-label"></label>
                        <input asp-for="Recovery.RecoveryCode" class="form-control" placeholder="XXXX-XXXX" />
                        <span asp-validation-for="Recovery.RecoveryCode" class="text-danger small"></span>
                    </div>
                    <div>
                        <label asp-for="Recovery.NewPassword" class="form-label"></label>
                        <input asp-for="Recovery.NewPassword" class="form-control" />
                        <span asp-validation-for="Recovery.NewPassword" class="text-danger small"></span>
                    </div>
                    <div>
                        <label asp-for="Recovery.ConfirmPassword" class="form-label"></label>
                        <input asp-for="Recovery.ConfirmPassword" class="form-control" />
                        <span asp-validation-for="Recovery.ConfirmPassword" class="text-danger small"></span>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-auto">Reset dengan Recovery Code</button>
                </form>
            </div>
        </div>
    </div>
    <div class="tab-pane fade @(activeTab == "email" ? "show active" : string.Empty)" id="tab-email" role="tabpanel">
        <div class="card shadow-sm equal-card">
            <div class="card-body d-flex flex-column">
                <h5 class="mb-1">Kode via Email</h5>
                <p class="text-muted">Masukkan email, minta kode OTP, lalu ganti password Anda.</p>
                <form asp-action="ResetPasswordWithEmail" method="post" class="mt-3 d-flex flex-column gap-3 flex-grow-1">
                    <div asp-validation-summary="ModelOnly" class="text-danger small"></div>
                    <div>
                        <label asp-for="EmailReset.Identifier" class="form-label">Email</label>
                        <div class="input-group">
                            <input asp-for="EmailReset.Identifier" class="form-control" autocomplete="username" />
                            <button type="button"
                                    class="btn btn-outline-primary"
                                    data-send-email-code
                                    data-label="Kirim Kode"
                                    data-url="@Url.Action("SendEmailResetCode")"
                                    data-status-target="#emailCodeStatus"
                                    data-cooldown-button
                                    data-cooldown-seconds="@emailCooldownSeconds">
                                Kirim Kode
                            </button>
                        </div>
                        <span asp-validation-for="EmailReset.Identifier" class="text-danger small"></span>
                        <div class="small mt-2" id="emailCodeStatus"></div>
                        @if (!string.IsNullOrWhiteSpace(devEmailResetCode))
                        {
                            <div class="alert alert-info small py-2 px-3 mt-2 mb-0">
                                Dev kode email: <strong>@devEmailResetCode</strong>
                            </div>
                        }
                    </div>
                    <div>
                        <label asp-for="EmailReset.Code" class="form-label"></label>
                        <input asp-for="EmailReset.Code" type="hidden" data-otp-hidden="EmailReset.Code" />
                        <div class="d-flex gap-2 otp-input-wrapper" data-otp-container="EmailReset.Code">
                            @for (var i = 0; i < 6; i++)
                            {
                                <input type="text"
                                       inputmode="numeric"
                                       maxlength="1"
                                       class="form-control text-center otp-input"
                                       autocomplete="one-time-code"
                                       data-otp-input />
                            }
                        </div>
                        <span asp-validation-for="EmailReset.Code" class="text-danger small"></span>
                    </div>
                    <div>
                        <label asp-for="EmailReset.NewPassword" class="form-label"></label>
                        <input asp-for="EmailReset.NewPassword" class="form-control" />
                        <span asp-validation-for="EmailReset.NewPassword" class="text-danger small"></span>
                    </div>
                    <div>
                        <label asp-for="EmailReset.ConfirmPassword" class="form-label"></label>
                        <input asp-for="EmailReset.ConfirmPassword" class="form-control" />
                        <span asp-validation-for="EmailReset.ConfirmPassword" class="text-danger small"></span>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-auto">Reset Password via Email</button>
                </form>
            </div>
        </div>
    </div>
    <div class="tab-pane fade @(activeTab == "sms" ? "show active" : string.Empty)" id="tab-sms" role="tabpanel">
        <div class="card shadow-sm equal-card">
            <div class="card-body d-flex flex-column">
                <h5 class="mb-1">Kode via SMS</h5>
                <p class="text-muted">Gunakan nomor Indonesia (+62). Kode OTP akan dikirim sebelum Anda mengganti password.</p>
                <form asp-action="ResetPasswordWithSms" method="post" class="mt-3 d-flex flex-column gap-3 flex-grow-1">
                    <div asp-validation-summary="ModelOnly" class="text-danger small"></div>
                    <div>
                        <label asp-for="SmsReset.Identifier" class="form-label">Nomor HP</label>
                        <div class="input-group">
                            <span class="input-group-text">+62</span>
                            <input asp-for="SmsReset.Identifier" class="form-control" placeholder="812xxxxxx" autocomplete="tel" />
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    data-send-sms-code
                                    data-label="Kirim Kode"
                                    data-url="@Url.Action("SendSmsResetCode")"
                                    data-status-target="#smsCodeStatus"
                                    data-cooldown-button
                                    data-cooldown-seconds="@smsCooldownSeconds">
                                Kirim Kode
                            </button>
                        </div>
                        <span asp-validation-for="SmsReset.Identifier" class="text-danger small"></span>
                        <div class="small mt-2" id="smsCodeStatus"></div>
                        @if (!string.IsNullOrWhiteSpace(devSmsResetCode))
                        {
                            <div class="alert alert-info small py-2 px-3 mt-2 mb-0">
                                Dev kode SMS: <strong>@devSmsResetCode</strong>
                            </div>
                        }
                    </div>
                    <div>
                        <label asp-for="SmsReset.Code" class="form-label"></label>
                        <input asp-for="SmsReset.Code" type="hidden" data-otp-hidden="SmsReset.Code" />
                        <div class="d-flex gap-2 otp-input-wrapper" data-otp-container="SmsReset.Code">
                            @for (var i = 0; i < 6; i++)
                            {
                                <input type="text"
                                       inputmode="numeric"
                                       maxlength="1"
                                       class="form-control text-center otp-input"
                                       autocomplete="one-time-code"
                                       data-otp-input />
                            }
                        </div>
                        <span asp-validation-for="SmsReset.Code" class="text-danger small"></span>
                    </div>
                    <div>
                        <label asp-for="SmsReset.NewPassword" class="form-label"></label>
                        <input asp-for="SmsReset.NewPassword" class="form-control" />
                        <span asp-validation-for="SmsReset.NewPassword" class="text-danger small"></span>
                    </div>
                    <div>
                        <label asp-for="SmsReset.ConfirmPassword" class="form-label"></label>
                        <input asp-for="SmsReset.ConfirmPassword" class="form-control" />
                        <span asp-validation-for="SmsReset.ConfirmPassword" class="text-danger small"></span>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-auto">Reset Password via SMS</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="text-center mt-4">
    <a asp-action="Login" class="link-secondary">Kembali ke halaman login</a>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (() => {
            const DEFAULT_COOLDOWN = 60;

            function startCooldown(button, seconds, statusSelector, baseMessage) {
                if (!button || seconds <= 0 || button.dataset.cooldownActive === '1')
                    return;

                button.dataset.cooldownActive = '1';
                const statusEl = statusSelector ? document.querySelector(statusSelector) : null;
                let remaining = seconds;
                button.disabled = true;

                const baseText = baseMessage ? `${baseMessage} ` : '';

                const updateStatus = () => {
                    if (statusEl) {
                        statusEl.textContent = `${baseText}Tunggu ${remaining} detik sebelum mengirim ulang.`;
                        statusEl.classList.remove('text-success', 'text-danger');
                        statusEl.classList.add('text-warning');
                    }
                };

                updateStatus();

                const intervalId = setInterval(() => {
                    remaining--;
                    if (remaining <= 0) {
                        clearInterval(intervalId);
                        button.disabled = false;
                        button.dataset.cooldownActive = '';
                        if (statusEl) {
                            statusEl.textContent = baseMessage ?? '';
                            if (!baseMessage)
                                statusEl.classList.remove('text-warning');
                        }
                    } else {
                        updateStatus();
                    }
                }, 1000);
            }

            function initCooldownButtons() {
                document.querySelectorAll('[data-cooldown-button]').forEach(button => {
                    const seconds = parseInt(button.dataset.cooldownSeconds ?? '0', 10);
                    if (seconds > 0) {
                        startCooldown(button, seconds, button.dataset.statusTarget, null);
                    }
                });
            }

            function initOtpInputs() {
                document.querySelectorAll('[data-otp-container]').forEach(container => {
                    const target = container.dataset.otpContainer;
                    if (!target) return;
                    const hidden = document.querySelector(`input[data-otp-hidden="${target}"]`);
                    if (!hidden) return;
                    const inputs = Array.from(container.querySelectorAll('input[data-otp-input]'));
                    if (!inputs.length) return;

                    const syncFromHidden = () => {
                        const value = (hidden.value || '').split('');
                        inputs.forEach((input, index) => {
                            input.value = value[index] ?? '';
                        });
                    };

                    const syncHidden = () => {
                        hidden.value = inputs.map(i => i.value ?? '').join('');
                    };

                    const focusNext = (currentIndex) => {
                        if (currentIndex + 1 < inputs.length) {
                            inputs[currentIndex + 1].focus();
                        }
                    };

                    const focusPrev = (currentIndex) => {
                        if (currentIndex - 1 >= 0) {
                            inputs[currentIndex - 1].focus();
                        }
                    };

                    inputs.forEach((input, index) => {
                        input.addEventListener('focus', () => {
                            input.select();
                        });

                        input.addEventListener('keydown', (event) => {
                            if (event.key === 'Backspace' && !input.value) {
                                event.preventDefault();
                                focusPrev(index);
                            }
                            if (event.key === 'ArrowLeft') {
                                event.preventDefault();
                                focusPrev(index);
                            }
                            if (event.key === 'ArrowRight') {
                                event.preventDefault();
                                focusNext(index);
                            }
                        });

                        input.addEventListener('input', (event) => {
                            const value = event.target.value.replace(/[^0-9]/g, '');
                            event.target.value = value.slice(-1);
                            syncHidden();
                            if (value.length) {
                                focusNext(index);
                            }
                        });

                        input.addEventListener('paste', (event) => {
                            event.preventDefault();
                            const pasted = (event.clipboardData?.getData('text') ?? '').replace(/[^0-9]/g, '');
                            if (!pasted.length) return;
                            inputs.forEach((inp, idx) => {
                                inp.value = pasted[idx] ?? '';
                            });
                            syncHidden();
                            const filled = Math.min(pasted.length, inputs.length - 1);
                            inputs[filled]?.focus();
                        });
                    });

                    syncFromHidden();
                });
            }

            const toast = window.Swal
                ? window.Swal.mixin({
                    toast: true,
                    position: 'bottom-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: toastInstance => {
                        toastInstance.addEventListener('mouseenter', window.Swal.stopTimer);
                        toastInstance.addEventListener('mouseleave', window.Swal.resumeTimer);
                    }
                })
                : null;

            function updateStatus(targetSelector, message, isSuccess) {
                if (!targetSelector) return;
                const el = document.querySelector(targetSelector);
                if (!el) return;
                el.textContent = message || '';
                el.classList.remove('text-success', 'text-danger');
                if (!message) return;
                el.classList.add(isSuccess ? 'text-success' : 'text-danger');
            }

            async function handleSendCode(button, fieldName, method) {
                const form = button.closest('form');
                if (!form) return;
                const input = form.querySelector(`[name="${fieldName}"]`);
                const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
                if (!input || !tokenInput) return;

                const value = input.value.trim();
                if (!value.length) {
                    const message = 'Isi field ini terlebih dahulu.';
                    updateStatus(button.dataset.statusTarget, message, false);
                    input.focus();
                    if (toast) toast.fire({ icon: 'error', title: message });
                    return;
                }

                const originalContent = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Mengirim...`;
                updateStatus(button.dataset.statusTarget, '', true);
                let cooldownData = null;

                try {
                    const body = new URLSearchParams();
                    body.append('__RequestVerificationToken', tokenInput.value);
                    body.append(fieldName, value);

                    const response = await fetch(button.dataset.url, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        body
                    });

                    let data = null;
                    try {
                        data = await response.json();
                    } catch {
                        data = null;
                    }

                    if (response.ok && data?.success) {
                        const baseMessage = data.message ?? 'Kode berhasil dikirim.';
                        const devCode = data.devCode;
                        const devLabel = method === 'sms' ? 'Kode dev SMS' : 'Kode dev email';
                        const finalMessage = devCode ? `${baseMessage} (${devLabel}: ${devCode})` : baseMessage;
                        updateStatus(button.dataset.statusTarget, finalMessage, true);
                        if (toast) toast.fire({ icon: 'success', title: finalMessage });
                        cooldownData = { seconds: data.cooldown ?? DEFAULT_COOLDOWN, message: baseMessage };
                    } else {
                        const fallbackError = data?.message
                            ?? data?.errors?.[0]?.messages?.[0]
                            ?? 'Gagal mengirim kode.';
                        updateStatus(button.dataset.statusTarget, fallbackError, false);
                        if (toast) toast.fire({ icon: 'error', title: fallbackError });
                        if (data?.remaining) {
                            cooldownData = { seconds: data.remaining, message: fallbackError };
                        }
                    }
                } catch {
                    const message = 'Terjadi kesalahan jaringan. Coba ulangi.';
                    updateStatus(button.dataset.statusTarget, message, false);
                    if (toast) toast.fire({ icon: 'error', title: message });
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                    if (cooldownData && cooldownData.seconds > 0) {
                        startCooldown(button, cooldownData.seconds, button.dataset.statusTarget, cooldownData.message);
                    }
                }
            }

            const emailButton = document.querySelector('[data-send-email-code]');
            if (emailButton) {
                emailButton.addEventListener('click', () =>
                    handleSendCode(emailButton, 'EmailReset.Identifier', 'email'));
            }

            const smsButton = document.querySelector('[data-send-sms-code]');
            if (smsButton) {
                smsButton.addEventListener('click', () =>
                    handleSendCode(smsButton, 'SmsReset.Identifier', 'sms'));
            }

            initOtpInputs();
            initCooldownButtons();
        })();
    </script>
}
