@model ProcurementHTE.Web.Models.ViewModels.WorkOrderCreateViewModel
@{
    ViewData["Title"] = "Create Work Order";
    var partialName = ViewBag.CreatePartial as string ?? "_CreateOther";
    var woTypeName = ViewBag.SelectedWoTypeName as string ?? "Other";
}

<header class="hstack justify-content-between mb-3">
    <div>
      <h2 class="mb-1">@ViewData["Title"]</h2>
      <p class="text-muted mb-0">Type: <span class="fw-semibold">@woTypeName</span></p>
    </div>
    <a class="btn btn-outline-secondary" asp-action="SelectType" role="button"><i class="bi bi-arrow-left"></i> Back</a>
</header>

<form asp-action="Create" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="WorkOrder.WoTypeId" />

    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold">Work Order Information</legend>
            <hr />
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="WorkOrder.ProcurementType" class="form-label"></label>
                    <select asp-for="WorkOrder.ProcurementType" class="form-select" asp-items="Html.GetEnumSelectList<ProcurementHTE.Core.Models.ProcurementType>()">
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="WorkOrder.DateLetter" class="form-label"></label>
                    <input type="date" class="form-control" asp-for="WorkOrder.DateLetter" />
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="WorkOrder.From" class="form-label"></label>
                    <input type="text" class="form-control" asp-for="WorkOrder.From" />
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="WorkOrder.To" class="form-label"></label>
                    <input type="text" class="form-control" asp-for="WorkOrder.To" />
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="WorkOrder.WorkOrderLetter" class="form-label"></label>
                    <input type="text" class="form-control" asp-for="WorkOrder.WorkOrderLetter" />
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="WorkOrder.WBS" class="form-label"></label>
                    <input type="text" class="form-control" asp-for="WorkOrder.WBS" />
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="WorkOrder.GlAccount" class="form-label"></label>
                    <input type="text" class="form-control" asp-for="WorkOrder.GlAccount" />
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="WorkOrder.DateRequired" class="form-label"></label>
                    <input type="date" class="form-control" asp-for="WorkOrder.DateRequired" />
                </div>
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
      <fieldset class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <legend class="card-title fw-semibold mb-0">Item Penawaran</legend>
          <button type="button" class="btn btn-outline-primary" id="btn-add-offer">
            <i class="bi bi-plus-lg"></i> 
          </button>
        </div>
        <hr />

        <div class="row g-3" id="offers-container">
          <div class="col-12 offer-row position-relative">
            <input type="hidden" name="Offers.Index" value="${key}" />
            <div class="mb-3 d-flex gap-3 align-items-end">
              <div class="w-100">
                <label class="form-label">Item Penawaran <span class="text-danger">*</span></label>
                <input class="form-control" name="Offers[${key}].ItemPenawaran" placeholder="Enter item penawaran" />
              </div>
              <div>
                <button type="button" class="btn btn-outline-danger js-remove-offer w-100">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold">Approval</legend>
            <hr />
            <div class="row">
                <div class="col-12 col-md-6 mb-3">
                    <label asp-for="WorkOrder.Requester" class="form-label"></label>
                    <input type="text" class="form-control" asp-for="WorkOrder.Requester" />
                </div>
                <div class="col-12 col-md-6 mb-3">
                    <label asp-for="WorkOrder.Approved" class="form-label"></label>
                    <input type="text" class="form-control" asp-for="WorkOrder.Approved" />
                </div>
            </div>
        </fieldset>
    </section>
    @await Html.PartialAsync(partialName, Model)
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
          // ========== Detail Items ==========
          const container = document.getElementById('details-container');
          const btnAdd = document.getElementById('btn-add-detail');

          if (!container || !btnAdd) return;

          function newKey() {
            return Math.random().toString(36).slice(2, 10);
          }

          // Skeleton Row input
          function rowMarkup(key) {
            return `
              <div class="col-12 detail-row position-relative">
                <input type="hidden" name="Details.Index" value="${key}" />
                <div class="row g-3 mb-3 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label">Item Name</label>
                    <input class="form-control" name="Details[${key}].ItemName" />
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Qty</label>
                    <input class="form-control" type="number" min="1" name="Details[${key}].Quantity" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Unit</label>
                    <input class="form-control" name="Details[${key}].Unit" />
                  </div>
                  <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger js-remove-detail">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>`;
          }

          // Tambah row
          btnAdd.addEventListener('click', function () {
            const key = newKey();
            container.insertAdjacentHTML('beforeend', rowMarkup(key));
            if (window.jQuery && $.validator && $.validator.unobtrusive) {
              $.validator.unobtrusive.parse(container);
            }
          });

          // Hapus row (delegasi)
          document.addEventListener('click', function (e) {
            const btn = e.target.closest('.js-remove-detail');
            if (!btn) return;
            const row = btn.closest('.detail-row');
            if (row) row.remove();
          });

          // ========== Offer Items ==========
          const offersContainer = document.getElementById('offers-container');
          const btnAddOffer = document.getElementById('btn-add-offer');

          function offerRowMarkup(key) {
              return `
                <div class="col-12 offer-row position-relative">
                  <input type="hidden" name="Offers.Index" value="${key}" />
                  <div class="mb-3 d-flex gap-3 align-items-end">
                    <div class="w-100">
                      <label class="form-label">Item Penawaran <span class="text-danger">*</span></label>
                      <input class="form-control" name="Offers[${key}].ItemPenawaran" placeholder="Enter item penawaran" />
                    </div>
                    <div>
                      <button type="button" class="btn btn-outline-danger js-remove-offer w-100">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              `;
          }

          if (btnAddOffer) {
            btnAddOffer.addEventListener('click', function () {
              const key = newKey();
              offersContainer.insertAdjacentHTML('beforeend', offerRowMarkup(key));
              if (window.jQuery && $.validator && $.validator.unobtrusive) {
                  $.validator.unobtrusive.parse(offersContainer);
              }
            })
          }

          document.addEventListener('click', function (e) {
              const btn = e.target.closest('.js-remove-offer');
              if (!btn) return;
              const row = btn.closest('.offer-row');
              if (row) row.remove();
          });
        });
    </script>
}
