@using Microsoft.AspNetCore.Mvc.Rendering
@model ProcurementHTE.Web.Models.ViewModels.CreateProfitLossViewModel
@{
    ViewData["Title"] = "Create Profit & Loss";
}

<form asp-action="CreatePnLPost" asp-controller="WorkOrders" method="post" class="needs-validation" novalidate>
    @Html.AntiForgeryToken()

    <!-- Hidden header values -->
    <input type="hidden" asp-for="WorkOrderId" />
    <input type="hidden" asp-for="WoNum" />
    <input type="hidden" asp-for="IssuedDate" />

    <header class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h3 mb-1">Create Profit &amp; Loss</h1>
            <span class="text-muted small">
                WO: <strong>@Model.WoNum</strong> &middot; Issued: @Model.IssuedDate.ToString("dd MMM yyyy")
            </span>
        </div>

        <div class="d-flex gap-2">
            <a asp-action="Details" asp-route-id="@Model.WorkOrderId" class="btn btn-outline-secondary" role="button">
                <i class="bi bi-arrow-left"></i> Back to WO
            </a>
        </div>
    </header>

    <div asp-validation-summary="ModelOnly" class="text-danger small mb-3"></div>

    <div class="row g-3">
        <!-- ================= TAGIHAN / HEADER ================= -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header"><h2 class="h6 mb-0 fw-semibold">Tagihan PDSI</h2></div>

                <div class="card-body">
                    <div class="row g-3 align-items-start">
                        <div class="col-md-4">
                            <label asp-for="Revenue" class="form-label">Revenue</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input asp-for="Revenue" class="form-control calc-recalc" inputmode="numeric" />
                            </div>
                            <span asp-validation-for="Revenue" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4">
                            <label asp-for="CostOperator" class="form-label">Cost Operator</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input asp-for="CostOperator" class="form-control calc-recalc" inputmode="numeric" />
                            </div>
                            <span asp-validation-for="CostOperator" class="text-danger small"></span>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Profit (otomatis)</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input id="Profit" name="Profit" class="form-control" readonly />
                            </div>
                            <small><span class="text-muted small">= Revenue - Best Offer - Cost Operator</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= PENAWARAN MITRA ================= -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="h6 mb-0 fw-semibold">Penawaran Mitra</h2>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-row">
                        <i class="bi bi-plus-lg"></i> Tambah Baris
                    </button>
                </div>

                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table align-middle table-bordered">
                            <thead class="table-light">
                                <tr class="text-nowrap text-center">
                                    <th style="width:50px;">#</th>
                                    <th style="min-width:220px;">Vendor</th>
                                    <th style="min-width:160px;">Item</th>
                                    <th style="width:90px;">Trip</th>
                                    <th style="width:120px;">Unit</th>
                                    <th style="min-width:170px;">Harga Penawaran</th>
                                    <th style="width:100px;">Best?</th>
                                    <th style="width:60px;"></th>
                                </tr>
                            </thead>

                            <tbody id="offers-body">
                                @for (var i = 0; i < Model.VendorOffers.Count; i++) {
                                    <tr data-row-index="@i">
                                        <td class="text-center">
                                            <span class="row-number">@Model.VendorOffers[i].RowIndex</span>
                                        </td>

                                        <td>
                                            <select class="form-select vendor-select" asp-for="VendorOffers[@i].VendorId" asp-items="Model.Vendors">
                                                <option value="">-- pilih vendor --</option>
                                            </select>
                                            <input type="hidden" asp-for="VendorOffers[@i].OfferNumber" />
                                            <span asp-validation-for="VendorOffers[@i].VendorId" class="text-danger small"></span>
                                        </td>

                                        <td>
                                            <input class="form-control" asp-for="VendorOffers[@i].ItemName" placeholder="mis. High Bed" />
                                        </td>

                                        <td>
                                            <input class="form-control" asp-for="VendorOffers[@i].Trip" inputmode="numeric" />
                                        </td>

                                        <td>
                                            <input class="form-control" asp-for="VendorOffers[@i].Unit" placeholder="Trip/Unit" />
                                        </td>

                                        <td>
                                            <div class="input-group">
                                                <span class="input-group-text">Rp</span>
                                                <input class="form-control offer-price calc-recalc"
                                                       asp-for="VendorOffers[@i].OfferPrice"
                                                       inputmode="numeric" />
                                            </div>
                                            <span asp-validation-for="VendorOffers[@i].OfferPrice" class="text-danger small"></span>
                                        </td>

                                        <td class="text-center">
                                            <input class="form-check-input choose-best" type="radio" name="bestRadio" />
                                        </td>

                                        <td class="text-center">
                                            <button class="btn btn-sm btn-outline-danger btn-remove-row" type="button" title="Hapus baris">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Best Offer Price (otomatis)</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input id="BestOfferPrice" name="BestOfferPrice" class="form-control" readonly />
                            </div>
                            <small><span class="text-muted small">Harga dari vendor terpilih (radio) atau otomatis terendah.</span></small>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="SelectedBestVendorId" class="form-label">Vendor Terpilih (opsional)</label>
                            <input asp-for="SelectedBestVendorId" class="form-control" placeholder="Best Vendor" readonly />
                            <span asp-validation-for="SelectedBestVendorId" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= RINGKASAN / ESTIMATE ================= -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header"><h2 class="h6 mb-0 fw-semibold">Profit &amp; Loss Estimate</h2></div>

                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Profit % (otomatis)</label>
                            <div class="input-group">
                                <input id="ProfitPercentage" name="ProfitPercentage" class="form-control" readonly />
                                <span class="input-group-text">%</span>
                            </div>
                            <small><span class="text-muted small">= Profit / Revenue × 100</span></small>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="AdjustmentRate" class="form-label">Adjustment Rate</label>
                            <div class="input-group">
                                <input asp-for="AdjustmentRate" class="form-control calc-recalc" inputmode="numeric" />
                                <span class="input-group-text">%</span>
                            </div>
                            <small><span class="form-text">Default 15%</span></small>
                            <span asp-validation-for="AdjustmentRate" class="text-danger small"></span>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Adjusted Profit (otomatis)</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input id="AdjustedProfit" name="AdjustedProfit" class="form-control" readonly />
                            </div>
                            <small><span class="text-muted small">= Profit × (1 + Adjustment%)</span></small>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Potential New Profit (otomatis)</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input id="PotentialNewProfit" name="PotentialNewProfit" class="form-control" readonly />
                            </div>
                            <small><span class="text-muted small">Sama dengan Adjusted Profit.</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= ACTIONS ================= -->
        <div class="col-12 d-flex gap-2 mb-3">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check2-circle"></i> Simpan P&amp;L
            </button>
        </div>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // ---------- Helpers ----------
        const toNumber = (v) => {
            if (v == null) return 0;
            if (typeof v === "number") return v;
            return Number(String(v)
                .replaceAll(".", "")
                .replaceAll(",", ".")
                .replace(/[^\d.-]/g, "")) || 0;
        };
        const fmtMoney = (n) => {
            try { return (n ?? 0).toLocaleString('id-ID', { maximumFractionDigits: 0 }); }
            catch { return n; }
        };
        const idRevenue   = "@Html.IdFor(m => m.Revenue)";
        const idCost      = "@Html.IdFor(m => m.CostOperator)";
        const idAdj       = "@Html.IdFor(m => m.AdjustmentRate)";
        const idBestSel   = "@Html.IdFor(m => m.SelectedBestVendorId)";
        const revenueEl   = document.getElementById(idRevenue);
        const costEl      = document.getElementById(idCost);
        const adjEl       = document.getElementById(idAdj);
        const bestSelect  = document.getElementById(idBestSel);

        const profitEl    = document.getElementById("Profit");
        const profitPctEl = document.getElementById("ProfitPercentage");
        const adjustedEl  = document.getElementById("AdjustedProfit");
        const potentialEl = document.getElementById("PotentialNewProfit");
        const bestOfferEl = document.getElementById("BestOfferPrice");
        const tbody       = document.getElementById("offers-body");

        function getOfferRows() {
            return Array.from(tbody.querySelectorAll("tr"));
        }
        function getPriceFromRow(tr) {
            const priceInput = tr.querySelector(".offer-price");
            return toNumber(priceInput?.value);
        }
        function getVendorIdFromRow(tr) {
            const sel = tr.querySelector(".vendor-select");
            return sel?.value || "";
        }
        function getCheckedBestRow() {
            return getOfferRows().find(tr => tr.querySelector(".choose-best")?.checked);
        }
        function minPositivePair(rows) {
            // return { price, vendorId } with minimum positive price
            let best = { price: 0, vendorId: "" };
            let min = Number.POSITIVE_INFINITY;
            rows.forEach(tr => {
                const p = getPriceFromRow(tr);
                if (p > 0 && p < min) {
                    min = p;
                    best = { price: p, vendorId: getVendorIdFromRow(tr) };
                }
            });
            return best;
        }

        function currentBest() {
            // 1) radio dipilih -> pakai baris tsb
            const checked = getCheckedBestRow();
            if (checked) {
                return { price: getPriceFromRow(checked), vendorId: getVendorIdFromRow(checked) };
            }
            // 2) jika dropdown SelectedBestVendorId diisi -> ambil dari baris vendor tsb
            const selectedVendor = bestSelect?.value;
            if (selectedVendor) {
                const row = getOfferRows().find(tr => getVendorIdFromRow(tr) === selectedVendor);
                if (row) return { price: getPriceFromRow(row), vendorId: selectedVendor };
            }
            // 3) fallback -> harga terendah > 0
            return minPositivePair(getOfferRows());
        }

        function recalc() {
            const revenue = toNumber(revenueEl?.value);
            const cost    = toNumber(costEl?.value);
            const adjRate = toNumber(adjEl?.value) / 100;

            const best = currentBest();

            // 👉 Auto-set SelectedBestVendorId jika user belum memilih manual & dropdown masih kosong
            if (best.vendorId && (!bestSelect?.value || bestSelect.value === "")) {
                bestSelect.value = best.vendorId;
            }

            const profit  = revenue - (best.price || 0) - cost;
            const pct     = revenue > 0 ? (profit / revenue) * 100 : 0;
            const adjusted = profit * (1 + adjRate);
            const potential = adjusted;

            bestOfferEl.value = fmtMoney(best.price || 0);
            profitEl.value    = fmtMoney(profit);
            profitPctEl.value = pct.toFixed(1);
            adjustedEl.value  = fmtMoney(adjusted);
            potentialEl.value = fmtMoney(potential);
        }

        // wire events for recalculation
        function wireRow(tr) {
            tr.querySelectorAll(".calc-recalc, .offer-price, .choose-best, .vendor-select").forEach(el => {
                el.addEventListener("input", recalc);
                el.addEventListener("change", recalc);
            });
        }
        getOfferRows().forEach(wireRow);

        // Add Row
        const btnAdd = document.getElementById("btn-add-row");
        if (btnAdd) {
            btnAdd.addEventListener("click", () => {
                const rows = getOfferRows();
                const nextIndex = rows.length;
                const nextOfferNumber = nextIndex + 1;
                const newTr = document.createElement("tr");
                newTr.setAttribute("data-row-index", String(nextIndex));
                newTr.innerHTML = `
                    <td class="text-center"><span class="row-number">${nextOfferNumber}</span></td>
                    <td>
                        <select class="form-select vendor-select" name="VendorOffers[${nextIndex}].VendorId">
                            <option value="">-- pilih vendor --</option>
                            ${Array.from(bestSelect.options).map(o => o.value ? `<option value="${o.value}">${o.text}</option>` : "").join("")}
                        </select>
                        <input type="hidden" name="VendorOffers[${nextIndex}].OfferNumber" value="${nextOfferNumber}" />
                    </td>
                    <td><input class="form-control" name="VendorOffers[${nextIndex}].ItemName" placeholder="mis. High Bed" /></td>
                    <td><input class="form-control" name="VendorOffers[${nextIndex}].Trip" inputmode="numeric" /></td>
                    <td><input class="form-control" name="VendorOffers[${nextIndex}].Unit" placeholder="Trip/Unit" /></td>
                    <td>
                        <div class="input-group">
                            <span class="input-group-text">Rp</span>
                            <input class="form-control offer-price calc-recalc" name="VendorOffers[${nextIndex}].OfferPrice" inputmode="numeric" />
                        </div>
                    </td>
                    <td class="text-center"><input class="form-check-input choose-best" type="radio" name="bestRadio" /></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger btn-remove-row" type="button" title="Hapus baris">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(newTr);
                wireRow(newTr);
                recalc();
            });
        }

        // Remove Row
        tbody.addEventListener("click", (e) => {
            const btn = e.target.closest(".btn-remove-row");
            if (!btn) return;
            const tr = btn.closest("tr");
            if (tr) {
                tr.remove();
                recalc();
            }
        });

        // initial calc
        document.querySelectorAll('.calc-recalc').forEach(el => {
            el.addEventListener('input', recalc);
            el.addEventListener('change', recalc);
        });
        bestSelect?.addEventListener('change', recalc);
        recalc();
    </script>
}
