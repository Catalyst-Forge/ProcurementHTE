@using ProcurementHTE.Web.Models.ViewModels
@model CreateProfitLossViewModel

@{
    ViewData["Title"] = "Buat Profit & Loss dengan Penawaran Vendor";
}

<style>
    .offer-row {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #0d6efd;
    }

        .offer-row:hover {
            background-color: #e9ecef;
            transition: all 0.3s ease;
        }

    .vendor-select-group {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .best-offer-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #28a745;
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
    }

    .offer-card {
        position: relative;
        border: 2px solid #e9ecef;
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .offer-card.selected {
            border-color: #28a745;
            background-color: #f0f9f5;
        }

        .offer-card:hover {
            border-color: #0d6efd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

    .readonly-box {
        background-color: #e9ecef;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #6c757d;
    }
</style>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0">
                <i class="bi bi-file-earmark-check"></i> Buat Profit & Loss Dengan Penawaran Vendor
            </h1>
        </div>
    </div>

    <form method="post" action="@Url.Action("CreateWithOffersPost", "ProfitLossMVC")"
          id="createPnLForm" class="needs-validation" novalidate>

        <!-- SECTION 1: Work Order Info (Read-only) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-file-text"></i> Informasi Work Order (Read-Only)
                        </h5>
                    </div>
                    <div class="card-body">
                        <input type="hidden" name="WorkOrderId" value="@Model.WorkOrderId">

                        <div class="row">
                            <div class="col-lg-3">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">No WO</label>
                                    <input type="text" class="form-control bg-light"
                                           value="@Model.WoNum" disabled>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Tanggal Terbit</label>
                                    <input type="text" class="form-control bg-light"
                                           value="@Model.IssuedDate.ToString("dd/MM/yyyy")" disabled>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Jarak (km)</label>
                                    <input type="text" class="form-control bg-light"
                                           value="10 (static) km" disabled>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Revenue Tagihan</label>
                                    <input type="text" class="form-control bg-light fw-bold"
                                           value="Rp @Model.Revenue" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: Vendor Offers Input -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-info text-white py-3">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-building"></i> Penawaran Vendor (Input Harga)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="vendorOffersContainer">
                            @for (int i = 0; i < Model.VendorOffers.Count; i++) {
                                <div class="offer-row" data-row-index="@i">
                                    <div class="row align-items-end">
                                        <!-- Vendor Dropdown -->
                                        <div class="col-lg-4">
                                            <label class="form-label fw-bold">
                                                Vendor Penawaran #@(i + 1)
                                            </label>
                                            <select name="VendorOffers[@i].VendorId"
                                                    class="form-select vendor-select"
                                                    onchange="updateVendorName(this, @i)">
                                                <option value="">-- Pilih Vendor --</option>
                                                @foreach (var vendor in Model.Vendors) {
                                                    <option value="@vendor.Value">@vendor.Text</option>
                                                }
                                            </select>
                                            <input type="hidden" name="VendorOffers[@i].VendorName"
                                                   class="vendor-name-input" value="">
                                            <input type="hidden" name="VendorOffers[@i].OfferNumber"
                                                   value="@(i + 1)">
                                            <input type="hidden" name="VendorOffers[@i].RowIndex"
                                                   value="@(i + 1)">
                                        </div>

                                        <!-- Offer Price -->
                                        <div class="col-lg-5">
                                            <label class="form-label fw-bold">Harga Penawaran</label>
                                            <div class="input-group input-group-lg">
                                                <span class="input-group-text">Rp</span>
                                                <input type="number"
                                                       name="VendorOffers[@i].OfferPrice"
                                                       class="form-control offer-price-input text-end"
                                                       placeholder="0"
                                                       step="1"
                                                       min="0"
                                                       onchange="updateBestOffer()">
                                            </div>
                                        </div>

                                        <!-- Best Offer Selection -->
                                        <div class="col-lg-3">
                                            <label class="form-label fw-bold d-block">
                                                <i class="bi bi-check-circle"></i> Pilih Terbaik
                                            </label>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input best-offer-radio"
                                                       type="radio"
                                                       name="SelectedBestVendorId"
                                                       id="bestOffer@i"
                                                       value="">
                                                <label class="form-check-label" for="bestOffer@i">
                                                    Terbaik
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="alert alert-warning mt-3" role="alert">
                            <i class="bi bi-info-circle"></i>
                            <strong>Informasi:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Isi minimal 1 penawaran vendor</li>
                                <li>Penawaran #1 = Harga Awal, #2 = Setelah Nego 1, #3 = Setelah Nego 2</li>
                                <li>Pilih radio button "Terbaik" untuk vendor dengan penawaran terbaik</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 3: Profit & Loss Input -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-warning text-dark py-3">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-calculator"></i> Data Profit & Loss
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-currency-dollar"></i> Cost Operator
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text">Rp</span>
                                        <input type="number"
                                               name="CostOperator"
                                               class="form-control text-end"
                                               step="0.01"
                                               min="0"
                                               required>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        Contoh: 8.986.402
                                    </small>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-percent"></i> Adjustment Rate
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <input type="number"
                                               name="AdjustmentRate"
                                               class="form-control text-end"
                                               value="@Model.AdjustmentRate"
                                               step="0.01"
                                               min="0"
                                               max="100">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        Default: 15% (0-100)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Preview Calculation -->
                        <div class="alert alert-light border-2 border-info mt-3" role="alert">
                            <h6 class="text-info fw-bold mb-2">
                                <i class="bi bi-calculator-fill"></i> Preview Perhitungan
                            </h6>
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <small class="text-muted d-block">Revenue</small>
                                    <strong class="text-primary fs-6">Rp @Model.Revenue</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted d-block">Cost Operator</small>
                                    <strong class="text-warning fs-6" id="previewCostOperator">Rp 0</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted d-block">Profit</small>
                                    <strong class="text-success fs-6" id="previewProfit">Rp 0</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted d-block">Profit %</small>
                                    <strong class="text-info fs-6" id="previewProfitPercent">0%</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ACTION BUTTONS -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                    <a href="@Url.Action("Index", "WorkOrder")" class="btn btn-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Kembali
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg" onclick="validateForm()">
                        <i class="bi bi-check-circle"></i> Buat Profit & Loss
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
<script>
    const revenue = @Model.Revenue;

    // Update vendor name saat dropdown berubah
    function updateVendorName(selectElement, rowIndex) {
        const selectedText = selectElement.options[selectElement.selectedIndex].text;
        const vendorNameInput = document.querySelector(
            `input[name="VendorOffers[rowIndex].VendorName"]`
                .replace('rowIndex', rowIndex)
        );
        if (vendorNameInput) {
            vendorNameInput.value = selectedText;
        }
        updateBestOffer();
    }

    // Update best offer - auto select terendah
    function updateBestOffer() {
        const offerInputs = document.querySelectorAll('.offer-price-input');
        let minPrice = Infinity;
        let minIndex = -1;

        offerInputs.forEach((input, index) => {
            const price = parseFloat(input.value) || 0;
            if (price > 0 && price < minPrice) {
                minPrice = price;
                minIndex = index;
            }
        });

        // Update radio buttons
        document.querySelectorAll('.best-offer-radio').forEach((radio, index) => {
            radio.checked = (index === minIndex);
        });

        // Update preview
        updatePreview();
    }

    // Update preview calculation
    function updatePreview() {
        const costOperatorInput = document.querySelector('input[name="CostOperator"]');
        const adjustmentRateInput = document.querySelector('input[name="AdjustmentRate"]');

        const costOperator = parseFloat(costOperatorInput?.value) || 0;
        const adjustmentRate = parseFloat(adjustmentRateInput?.value) / 100 || 0;

        const profit = revenue - costOperator;
        const profitPercent = revenue > 0 ? (profit / revenue) * 100 : 0;

        // Format dan update preview
        document.getElementById('previewCostOperator').textContent =
            'Rp ' + costOperator.toLocaleString('id-ID', {maximumFractionDigits: 0});
        document.getElementById('previewProfit').textContent =
            'Rp ' + profit.toLocaleString('id-ID', {maximumFractionDigits: 0});
        document.getElementById('previewProfitPercent').textContent =
            profitPercent.toFixed(2) + '%';
    }

    // Validate form sebelum submit
    function validateForm() {
        const selectedBestVendor = document.querySelector('input[name="SelectedBestVendorId"]:checked');

        if (!selectedBestVendor || !selectedBestVendor.value) {
            alert('⚠️ Silakan pilih vendor dengan penawaran terbaik!');
            return false;
        }

        const costOperator = document.querySelector('input[name="CostOperator"]').value;
        if (!costOperator || costOperator <= 0) {
            alert('⚠️ Cost Operator harus diisi dengan nilai > 0');
            return false;
        }

        return true;
    }

    // Initialize preview on page load
    document.addEventListener('DOMContentLoaded', function() {
        updatePreview();

        // Add event listeners
        document.querySelector('input[name="CostOperator"]').addEventListener('change', updatePreview);
        document.querySelector('input[name="AdjustmentRate"]').addEventListener('change', updatePreview);

        // Bootstrap validation
        const forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    });
</script>
}