@model ProcurementHTE.Web.Models.ViewModels.ProcurementCreateViewModel
@using Microsoft.AspNetCore.Mvc.Rendering
@using System.Linq
@{
    ViewData["Title"] = "Create Procurement";
    var partialName = ViewBag.CreatePartial as string ?? "_CreateOther";
    var jobTypeName = ViewBag.SelectedJobTypeName as string ?? "Other";
    var procurement = Model.Procurement ??= new Procurement();
    Model.Details ??= new List<ProcDetail>();
    Model.Offers ??= new List<ProcOffer>();

    var contractTypeOptions = Html.GetEnumSelectList<ProcurementHTE.Core.Enums.ContractType>();
    var projectRegionOptions = Html.GetEnumSelectList<ProcurementHTE.Core.Enums.ProjectRegion>();

    var picOpsOptions = (Model.PicOpsUsers ?? Enumerable.Empty<SelectListItem>()).ToList();
    var analystOptions = (Model.AnalystUsers ?? Enumerable.Empty<SelectListItem>()).ToList();
    var assistantManagerOptions = (Model.AssistantManagerUsers ?? Enumerable.Empty<SelectListItem>()).ToList();
    var managerOptions = (Model.ManagerUsers ?? Enumerable.Empty<SelectListItem>()).ToList();

    var emptyOfferKey = Guid.NewGuid().ToString("N");
}

<header class="hstack justify-content-between mb-3">
    <div>
        <h2 class="mb-1">@ViewData["Title"]</h2>
        <p class="text-muted mb-0">Type: <span class="fw-semibold">@jobTypeName</span></p>
    </div>
    <a class="btn btn-outline-secondary" asp-action="SelectType" role="button">
        <i class="bi bi-arrow-left"></i> Back
    </a>
</header>

<form asp-action="Create" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Procurement.JobTypeId" />

    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold">Procurement Overview</legend>
            <hr />
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Job Type</label>
                    <input class="form-control-plaintext fw-semibold" value="@jobTypeName" readonly />
                </div>
                <div class="col-md-4">
                    <label asp-for="Procurement.ContractType" class="form-label"></label>
                    <select asp-for="Procurement.ContractType" class="form-select" asp-items="contractTypeOptions">
                        <option value="">Select contract type</option>
                    </select>
                    <span class="text-danger" asp-validation-for="Procurement.ContractType"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Procurement.JobTypeOther" class="form-label"></label>
                    <input asp-for="Procurement.JobTypeOther" class="form-control" />
                    <span class="text-danger" asp-validation-for="Procurement.JobTypeOther"></span>
                </div>
            </div>

            <div class="row g-3 mt-0">
                <div class="col-md-6">
                    <label asp-for="Procurement.JobName" class="form-label"></label>
                    <textarea asp-for="Procurement.JobName" class="form-control" rows="3" maxlength="200"></textarea>
                    <span class="text-danger" asp-validation-for="Procurement.JobName"></span>
                </div>
                <div class="col-md-3">
                    <label asp-for="Procurement.ProjectRegion" class="form-label"></label>
                    <select asp-for="Procurement.ProjectRegion" class="form-select" asp-items="projectRegionOptions">
                        <option value="">Select project region</option>
                    </select>
                    <span class="text-danger" asp-validation-for="Procurement.ProjectRegion"></span>
                </div>
                <div class="col-md-3">
                    <label asp-for="Procurement.ProjectCode" class="form-label"></label>
                    <input asp-for="Procurement.ProjectCode" class="form-control" />
                    <span class="text-danger" asp-validation-for="Procurement.ProjectCode"></span>
                </div>
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold">Schedule &amp; Amounts</legend>
            <hr />

            <div class="row g-3">
                <div class="col-md-4">
                    <label asp-for="Procurement.StartDate" class="form-label"></label>
                    <input asp-for="Procurement.StartDate" type="date" class="form-control" />
                    <span class="text-danger" asp-validation-for="Procurement.StartDate"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Procurement.EndDate" class="form-label"></label>
                    <input asp-for="Procurement.EndDate" type="date" class="form-control" />
                    <span class="text-danger" asp-validation-for="Procurement.EndDate"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Procurement.PotentialAccrualDate" class="form-label"></label>
                    <input asp-for="Procurement.PotentialAccrualDate" type="date" class="form-control" />
                    <span class="text-danger" asp-validation-for="Procurement.PotentialAccrualDate"></span>
                </div>
            </div>

            <div class="row g-3 mt-0">
                <div class="col-md-4">
                    <label asp-for="Procurement.AccrualAmount" class="form-label"></label>
                    <input asp-for="Procurement.AccrualAmount" asp-format="{0:0}" class="form-control text-end" inputmode="numeric" />
                    <span class="text-danger" asp-validation-for="Procurement.AccrualAmount"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Procurement.RealizationAmount" class="form-label"></label>
                    <input asp-for="Procurement.RealizationAmount" asp-format="{0:0}" class="form-control text-end" inputmode="numeric" />
                    <span class="text-danger" asp-validation-for="Procurement.RealizationAmount"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Procurement.LtcName" class="form-label"></label>
                    <input asp-for="Procurement.LtcName" class="form-control" />
                    <span class="text-danger" asp-validation-for="Procurement.LtcName"></span>
                </div>
            </div>

            <div class="mt-3">
                <label asp-for="Procurement.Note" class="form-label"></label>
                <textarea asp-for="Procurement.Note" class="form-control" rows="3" maxlength="1000"></textarea>
                <span class="text-danger" asp-validation-for="Procurement.Note"></span>
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold">Reference Numbers</legend>
            <hr />
            <div class="row g-3">
                <div class="col-md-4">
                    <label asp-for="Procurement.SpkNumber" class="form-label"></label>
                    <input asp-for="Procurement.SpkNumber" class="form-control" />
                    <span class="text-danger" asp-validation-for="Procurement.SpkNumber"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Procurement.SpmpNumber" class="form-label"></label>
                    <input asp-for="Procurement.SpmpNumber" class="form-control" />
                    <span class="text-danger" asp-validation-for="Procurement.SpmpNumber"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Procurement.MemoNumber" class="form-label"></label>
                    <input asp-for="Procurement.MemoNumber" class="form-control" />
                    <span class="text-danger" asp-validation-for="Procurement.MemoNumber"></span>
                </div>
            </div>

            <div class="row g-3 mt-0">
                <div class="col-md-6">
                    <label asp-for="Procurement.OeNumber" class="form-label"></label>
                    <input asp-for="Procurement.OeNumber" class="form-control" />
                    <span class="text-danger" asp-validation-for="Procurement.OeNumber"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="Procurement.RaNumber" class="form-label"></label>
                    <input asp-for="Procurement.RaNumber" class="form-control" />
                    <span class="text-danger" asp-validation-for="Procurement.RaNumber"></span>
                </div>
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <legend class="card-title fw-semibold mb-0">Item Penawaran</legend>
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-offer">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
            <hr />

            <div class="row g-3" id="offers-container">
                @if (Model.Offers.Any())
                {
                    for (var i = 0; i < Model.Offers.Count; i++)
                    {
                        <div class="col-12 offer-row position-relative">
                            <input type="hidden" name="Offers.Index" value="@i" />
                            <div class="row g-3 align-items-end">
                                <div class="col-lg-10">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Item Penawaran <span class="text-danger">*</span></label>
                                            <input asp-for="Offers[i].ItemPenawaran" class="form-control" />
                                            <span class="text-danger" asp-validation-for="Offers[i].ItemPenawaran"></span>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Qty</label>
                                            <input asp-for="Offers[i].Qty" type="number" min="1" step="1" class="form-control text-end" />
                                            <span class="text-danger" asp-validation-for="Offers[i].Qty"></span>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Unit</label>
                                            <input asp-for="Offers[i].Unit" class="form-control" />
                                            <span class="text-danger" asp-validation-for="Offers[i].Unit"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-2 d-flex justify-content-end">
                                    <button type="button" class="btn btn-outline-danger js-remove-offer w-100">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12 offer-row position-relative">
                        <input type="hidden" name="Offers.Index" value="@emptyOfferKey" />
                        <div class="row g-3 align-items-end">
                            <div class="col-lg-10">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Item Penawaran <span class="text-danger">*</span></label>
                                        <input class="form-control" name="Offers[@emptyOfferKey].ItemPenawaran" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Qty</label>
                                        <input class="form-control text-end" type="number" min="1" step="1" name="Offers[@emptyOfferKey].Qty" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Unit</label>
                                        <input class="form-control" name="Offers[@emptyOfferKey].Unit" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 d-flex justify-content-end">
                                <button type="button" class="btn btn-outline-danger js-remove-offer w-100">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold">Approvals &amp; PIC</legend>
            <hr />
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="Procurement.PicOpsUserId" class="form-label">PIC Operations</label>
                    <select asp-for="Procurement.PicOpsUserId" class="form-select" asp-items="picOpsOptions">
                        <option value="">Select PIC Operations</option>
                    </select>
                    <span class="text-danger" asp-validation-for="Procurement.PicOpsUserId"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="Procurement.AnalystHteUserId" class="form-label">Analyst HTE &amp; LTS</label>
                    <select asp-for="Procurement.AnalystHteUserId" class="form-select" asp-items="analystOptions">
                        <option value="">Select Analyst</option>
                    </select>
                    <span class="text-danger" asp-validation-for="Procurement.AnalystHteUserId"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="Procurement.AssistantManagerUserId" class="form-label">Assistant Manager HTE</label>
                    <select asp-for="Procurement.AssistantManagerUserId" class="form-select" asp-items="assistantManagerOptions">
                        <option value="">Select Assistant Manager</option>
                    </select>
                    <span class="text-danger" asp-validation-for="Procurement.AssistantManagerUserId"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="Procurement.ManagerUserId" class="form-label">Manager Transport &amp; Logistic</label>
                    <select asp-for="Procurement.ManagerUserId" class="form-select" asp-items="managerOptions">
                        <option value="">Select Manager</option>
                    </select>
                    <span class="text-danger" asp-validation-for="Procurement.ManagerUserId"></span>
                </div>
            </div>
        </fieldset>
    </section>

    @await Html.PartialAsync(partialName, Model)
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const detailsContainer = document.getElementById('details-container');
            const btnAddDetail = document.getElementById('btn-add-detail');
            const offersContainer = document.getElementById('offers-container');
            const btnAddOffer = document.getElementById('btn-add-offer');

            const newKey = () => Math.random().toString(36).slice(2, 10);

            const detailRowMarkup = (key) => `
                <div class="col-12 detail-row position-relative">
                    <input type="hidden" name="Details.Index" value="${key}" />
                    <div class="row g-3 align-items-end">
                        <div class="col-lg-10">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label">Item Name</label>
                                    <input class="form-control" name="Details[${key}].ItemName" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Qty</label>
                                    <input class="form-control text-end" type="number" min="1" step="1" name="Details[${key}].Quantity" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Unit</label>
                                    <input class="form-control" name="Details[${key}].Unit" />
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-danger js-remove-detail w-100">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const offerRowMarkup = (key) => `
                <div class="col-12 offer-row position-relative">
                    <input type="hidden" name="Offers.Index" value="${key}" />
                    <div class="row g-3 align-items-end">
                        <div class="col-lg-10">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Item Penawaran <span class="text-danger">*</span></label>
                                    <input class="form-control" name="Offers[${key}].ItemPenawaran" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Qty</label>
                                    <input class="form-control text-end" type="number" min="1" step="1" name="Offers[${key}].Qty" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Unit</label>
                                    <input class="form-control" name="Offers[${key}].Unit" />
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-danger js-remove-offer w-100">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const parseValidation = (target) => {
                if (window.jQuery && $.validator && $.validator.unobtrusive) {
                    $.validator.unobtrusive.parse(target);
                }
            };

            if (btnAddDetail && detailsContainer) {
                btnAddDetail.addEventListener('click', () => {
                    const key = newKey();
                    detailsContainer.insertAdjacentHTML('beforeend', detailRowMarkup(key));
                    parseValidation(detailsContainer);
                });

                detailsContainer.addEventListener('click', (event) => {
                    const btn = event.target.closest('.js-remove-detail');
                    if (!btn) return;
                    const row = btn.closest('.detail-row');
                    if (row) row.remove();
                });
            }

            if (btnAddOffer && offersContainer) {
                btnAddOffer.addEventListener('click', () => {
                    const key = newKey();
                    offersContainer.insertAdjacentHTML('beforeend', offerRowMarkup(key));
                    parseValidation(offersContainer);
                });

                offersContainer.addEventListener('click', (event) => {
                    const btn = event.target.closest('.js-remove-offer');
                    if (!btn) return;
                    const row = btn.closest('.offer-row');
                    if (row) row.remove();
                });
            }
        });
    </script>
}
