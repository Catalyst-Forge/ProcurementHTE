@model ProcurementHTE.Web.Models.ViewModels.ProcurementEditViewModel
@using Microsoft.AspNetCore.Mvc.Rendering
@using System.Collections.Generic
@using System.Linq
@{
    ViewData["Title"] = "Work Order Data Edit";
    var jobTypeName = ViewBag.SelectedJobTypeName as string ?? "Other";

    Model.Details ??= new List<ProcDetail>();
    Model.Offers ??= new List<ProcOffer>();

    var jobTypeOptions = (Model.JobTypes ?? Enumerable.Empty<JobTypes>())
        .Select(job => new SelectListItem
        {
            Value = job.JobTypeId,
            Text = job.TypeName
        })
        .ToList();

    var statusOptions = (Model.Statuses ?? Enumerable.Empty<Status>())
        .Select(status => new SelectListItem
        {
            Value = status.StatusId.ToString(),
            Text = status.StatusName
        })
        .ToList();

    var contractTypeOptions = Html.GetEnumSelectList<ProcurementHTE.Core.Enums.ContractType>();
    var projectRegionOptions = Html.GetEnumSelectList<ProcurementHTE.Core.Enums.ProjectRegion>();
    var picOpsOptions = Model.PicOpsUsers ?? Enumerable.Empty<SelectListItem>();
    var analystOptions = Model.AnalystUsers ?? Enumerable.Empty<SelectListItem>();
    var assistantManagerOptions = Model.AssistantManagerUsers ?? Enumerable.Empty<SelectListItem>();
    var managerOptions = Model.ManagerUsers ?? Enumerable.Empty<SelectListItem>();
}

<header class="hstack justify-content-between mb-3 border-bottom pb-2">
    <div>
        <h1 class="h3 mb-0">Edit Work Order</h1>
        <p class="text-muted mb-0">
            WO Number: <span class="fw-semibold">@Model.ProcNum</span>
            Type: <span class="fw-semibold">@jobTypeName</span>
        </p>
    </div>
    <a class="btn btn-outline-secondary" asp-action="Index" role="button">
        <i class="bi bi-arrow-left"></i> Back to list
    </a>
</header>

<form asp-action="Edit" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()

    <input type="hidden" asp-for="ProcurementId" />
    <input type="hidden" asp-for="ProcNum" />

    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold">
                <i class="bi bi-info-circle-fill text-primary me-1"></i> Header Information
            </legend>
            <hr />

            <div class="row g-3 mb-2">
                <div class="col-md-4">
                    <label asp-for="ProcNum" class="form-label"></label>
                    <input asp-for="ProcNum" class="form-control-plaintext fw-semibold" readonly />
                    <span class="form-text text-muted">Auto-generated &mdash; not editable</span>
                </div>
                <div class="col-md-4">
                    <label asp-for="ContractType" class="form-label"></label>
                    <select asp-for="ContractType" class="form-select" asp-items="contractTypeOptions">
                        <option value="" disabled>Select contract type</option>
                    </select>
                    <span asp-validation-for="ContractType" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="LtcName" class="form-label"></label>
                    <input asp-for="LtcName" class="form-control" />
                    <span asp-validation-for="LtcName" class="text-danger"></span>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="ProjectRegion" class="form-label"></label>
                    <select asp-for="ProjectRegion" class="form-select" asp-items="projectRegionOptions">
                        <option value="" disabled>Select project region</option>
                    </select>
                    <span asp-validation-for="ProjectRegion" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="ProjectCode" class="form-label"></label>
                    <input asp-for="ProjectCode" class="form-control" />
                    <span asp-validation-for="ProjectCode" class="text-danger"></span>
                </div>
            </div>

            <div class="row g-3 mt-0">
                <div class="col-md-12">
                    <label asp-for="JobName" class="form-label"></label>
                    <textarea asp-for="JobName" class="form-control" rows="3"></textarea>
                    <span asp-validation-for="JobName" class="text-danger"></span>
                </div>
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold">
                <i class="bi bi-geo-alt-fill text-primary me-1"></i> Schedule &amp; Location
            </legend>
            <hr />

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="StartDate" class="form-label"></label>
                    <input asp-for="StartDate" type="date" class="form-control" />
                    <span asp-validation-for="StartDate" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="EndDate" class="form-label"></label>
                    <input asp-for="EndDate" type="date" class="form-control" />
                    <span asp-validation-for="EndDate" class="text-danger"></span>
                </div>
                
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold">
                <i class="bi bi-cash-coin text-primary me-1"></i> Financial &amp; References
            </legend>
            <hr />

            <div class="row g-3">
                <div class="col-md-4">
                    <label asp-for="AccrualAmount" class="form-label"></label>
                    <input asp-for="AccrualAmount" asp-format="{0:0}" class="form-control text-end" type="number" inputmode="numeric" />
                    <span asp-validation-for="AccrualAmount" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="RealizationAmount" class="form-label"></label>
                    <input asp-for="RealizationAmount" asp-format="{0:0}" class="form-control text-end" type="number" inputmode="numeric" />
                    <span asp-validation-for="RealizationAmount" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="PotentialAccrualDate" class="form-label"></label>
                    <input asp-for="PotentialAccrualDate" type="date" class="form-control" />
                    <span asp-validation-for="PotentialAccrualDate" class="text-danger"></span>
                </div>
            </div>

            <div class="row g-3 mt-0">
                <div class="col-md-4">
                    <label asp-for="SpkNumber" class="form-label"></label>
                    <input asp-for="SpkNumber" class="form-control" />
                    <span asp-validation-for="SpkNumber" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="SpmpNumber" class="form-label"></label>
                    <input asp-for="SpmpNumber" class="form-control" />
                    <span asp-validation-for="SpmpNumber" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="MemoNumber" class="form-label"></label>
                    <input asp-for="MemoNumber" class="form-control" />
                    <span asp-validation-for="MemoNumber" class="text-danger"></span>
                </div>
            </div>

            <div class="row g-3 mt-0">
                <div class="col-md-6">
                    <label asp-for="OeNumber" class="form-label"></label>
                    <input asp-for="OeNumber" class="form-control" />
                    <span asp-validation-for="OeNumber" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="RaNumber" class="form-label"></label>
                    <input asp-for="RaNumber" class="form-control" />
                    <span asp-validation-for="RaNumber" class="text-danger"></span>
                </div>
            </div>

            <div class="mt-3">
                <label asp-for="Note" class="form-label"></label>
                <textarea asp-for="Note" class="form-control" rows="3"></textarea>
                <span asp-validation-for="Note" class="text-danger"></span>
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold">
                <i class="bi bi-people-fill text-primary me-1"></i> PIC &amp; Approvals
            </legend>
            <hr />

            <div class="row g-3">
                <div class="col-md-3">
                    <label asp-for="PicOpsUserId" class="form-label">PIC Operations</label>
                    <select asp-for="PicOpsUserId" class="form-select" asp-items="picOpsOptions">
                        <option value="">Select PIC Operations</option>
                    </select>
                    <span asp-validation-for="PicOpsUserId" class="text-danger"></span>
                </div>
                <div class="col-md-3">
                    <label asp-for="AnalystHteUserId" class="form-label">Analyst HTE &amp; LTS</label>
                    <select asp-for="AnalystHteUserId" class="form-select" asp-items="analystOptions">
                        <option value="">Select Analyst</option>
                    </select>
                    <span asp-validation-for="AnalystHteUserId" class="text-danger"></span>
                </div>
                <div class="col-md-3">
                    <label asp-for="AssistantManagerUserId" class="form-label">Assistant Manager HTE</label>
                    <select asp-for="AssistantManagerUserId" class="form-select" asp-items="assistantManagerOptions">
                        <option value="">Select Assistant Manager</option>
                    </select>
                    <span asp-validation-for="AssistantManagerUserId" class="text-danger"></span>
                </div>
                <div class="col-md-3">
                    <label asp-for="ManagerUserId" class="form-label">Manager Transport &amp; Logistic</label>
                    <select asp-for="ManagerUserId" class="form-select" asp-items="managerOptions">
                        <option value="">Select Manager</option>
                    </select>
                    <span asp-validation-for="ManagerUserId" class="text-danger"></span>
                </div>
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <legend class="card-title fw-semibold mb-0">
                    <i class="bi bi-bag-plus text-primary me-1"></i> Item Penawaran
                </legend>
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-offer">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
            <hr />

            <div class="row g-3" id="offers-container">
                @for (var i = 0; i < Model.Offers.Count; i++)
                {
                    <div class="col-12 offer-row position-relative">
                        <input type="hidden" name="Offers.Index" value="@i" />

                        <div class="row g-3 align-items-end">
                            <div class="col-lg-10">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Item Penawaran <span class="text-danger">*</span></label>
                                        <input asp-for="Offers[i].ItemPenawaran" class="form-control" />
                                        <span asp-validation-for="Offers[i].ItemPenawaran" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Qty</label>
                                        <input asp-for="Offers[i].Qty" type="number" min="1" step="1" class="form-control text-end" />
                                        <span asp-validation-for="Offers[i].Qty" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Unit</label>
                                        <input asp-for="Offers[i].Unit" class="form-control" />
                                        <span asp-validation-for="Offers[i].Unit" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 d-flex justify-content-end">
                                <button type="button" class="btn btn-outline-danger js-remove-offer w-100">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </fieldset>
    </section>

    <div class="mb-3 d-flex w-100 justify-content-end">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check2-circle"></i> Save Changes
        </button>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const detailsContainer = document.getElementById('details-container');
            const btnAddDetail = document.getElementById('btn-add-detail');
            const offersContainer = document.getElementById('offers-container');
            const btnAddOffer = document.getElementById('btn-add-offer');

            const newKey = () => Math.random().toString(36).slice(2, 10);

            const detailRowMarkup = (key) => `
                <div class="col-12 detail-row position-relative">
                    <input type="hidden" name="Details.Index" value="${key}" />
                    <div class="row g-3 align-items-end">
                        <div class="col-lg-10">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label">Item Name</label>
                                    <input class="form-control" name="Details[${key}].ItemName" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Quantity</label>
                                    <input class="form-control text-end" type="number" min="1" step="1" name="Details[${key}].Quantity" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Unit</label>
                                    <input class="form-control" name="Details[${key}].Unit" />
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-danger js-remove-detail w-100">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const offerRowMarkup = (key) => `
                <div class="col-12 offer-row position-relative">
                    <input type="hidden" name="Offers.Index" value="${key}" />
                    <div class="row g-3 align-items-end">
                        <div class="col-lg-10">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Item Penawaran <span class="text-danger">*</span></label>
                                    <input class="form-control" name="Offers[${key}].ItemPenawaran" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Qty</label>
                                    <input class="form-control text-end" type="number" min="1" step="1" name="Offers[${key}].Qty" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Unit</label>
                                    <input class="form-control" name="Offers[${key}].Unit" />
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-danger js-remove-offer w-100">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            if (btnAddDetail && detailsContainer) {
                btnAddDetail.addEventListener('click', () => {
                    const key = newKey();
                    detailsContainer.insertAdjacentHTML('beforeend', detailRowMarkup(key));
                    if (window.jQuery && $.validator && $.validator.unobtrusive) {
                        $.validator.unobtrusive.parse(detailsContainer);
                    }
                });
            }

            if (btnAddOffer && offersContainer) {
                btnAddOffer.addEventListener('click', () => {
                    const key = newKey();
                    offersContainer.insertAdjacentHTML('beforeend', offerRowMarkup(key));
                    if (window.jQuery && $.validator && $.validator.unobtrusive) {
                        $.validator.unobtrusive.parse(offersContainer);
                    }
                });
            }

            document.addEventListener('click', (event) => {
                const btnDetail = event.target.closest('.js-remove-detail');
                if (btnDetail) {
                    const row = btnDetail.closest('.detail-row');
                    if (row) {
                        row.remove();
                    }
                }

                const btnOffer = event.target.closest('.js-remove-offer');
                if (btnOffer) {
                    const row = btnOffer.closest('.offer-row');
                    if (row) {
                        row.remove();
                    }
                }
            });
        });
    </script>
}
