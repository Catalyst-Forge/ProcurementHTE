@model ProcurementHTE.Web.Models.ViewModels.WorkOrderEditViewModel
@{
    ViewData["Title"] = "Work Order Data Edit";
    var woTypeName = ViewBag.SelectedWoTypeName as string ?? "Other";
}

<header class="hstack justify-content-between mb-3 border-bottom pb-2">
    <div>
        <h1 class="h3 mb-0">Edit Work Order</h1>
        <p class="text-muted mb-0">
            WO Number: <span class="fw-semibold">@Model.WoNum</span>
            Type: <span class="fw-semibold">@woTypeName</span>
        </p>
    </div>
    <a class="btn btn-outline-secondary" asp-action="Index" role="button"><i class="bi bi-arrow-left"></i> Back to list</a>
</header>

<form asp-action="Edit" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="All" class="text-danger"></div>
    <input type="hidden" asp-for="WorkOrderId" />
    <input type="hidden" asp-for="ProcurementType" />
    <input type="hidden" asp-for="WoTypeId" />
    @* <input type="hidden" asp-for="UserId" /> *@
    <input type="hidden" asp-for="WoNum" />
    <input type="hidden" asp-for="StatusId" />

    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold"><i class="bi bi-info-circle-fill text-primary me-1"></i> Header Information</legend>
            <hr />
            <div class="row">
                <div class="col-12 col-sm-auto col-md-4">
                    <div class="mb-3">
                        <label asp-for="WoNum" class="form-label"></label>
                        <input type="text" asp-for="WoNum" class="form-control-plaintext" value="@Model.WoNum" readonly />
                        <span class="form-text">Auto-generated • not editable</span>
                    </div>
                </div>

                <div class="col-12 col-sm-auto col-md-4">
                    <div class="mb-3">
                        <label asp-for="WoNumLetter" class="form-label"></label>
                        <input type="text" asp-for="WoNumLetter" class="form-control" />
                        <span asp-validation-for="WoNumLetter" class="text-danger"></span>
                    </div>
                </div>

                <div class="col-12 col-sm-auto col-md-4">
                    <div class="mb-3">
                        <label asp-for="WorkOrderLetter" class="form-label"></label>
                        <input type="text" asp-for="WorkOrderLetter" class="form-control" />
                        <span asp-validation-for="WorkOrderLetter" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="mb-3">
                        <label asp-for="DateLetter" class="form-label"></label>
                        <input type="date" asp-for="DateLetter" class="form-control" />
                        <span asp-validation-for="DateLetter" class="text-danger"></span>
                    </div>
                </div>

                <div class="col">
                    <div class="mb-3">
                        <label asp-for="DateRequired" class="form-label"></label>
                        <input type="date" asp-for="DateRequired" class="form-control" />
                        <span asp-validation-for="DateRequired" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12 col-sm">
                    <div class="mb-3">
                        <label asp-for="From" class="form-label"></label>
                        <input type="text" asp-for="From" class="form-control" />
                        <span asp-validation-for="From" class="text-danger"></span>
                    </div>
                </div>

                <div class="col-12 col-sm">
                    <div class="mb-3">
                        <label asp-for="To" class="form-label"></label>
                        <input type="text" asp-for="To" class="form-control" />
                        <span asp-validation-for="To" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12 col-sm">
                    <div class="mb-3">
                        <label asp-for="WBS" class="form-label"></label>
                        <input type="text" asp-for="WBS" class="form-control" />
                        <span asp-validation-for="WBS" class="text-danger"></span>
                    </div>
                </div>

                <div class="col-12 col-sm">
                    <div class="mb-3">
                        <label asp-for="GlAccount" class="form-label"></label>
                        <input type="text" asp-for="GlAccount" class="form-control" />
                        <span asp-validation-for="GlAccount" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <legend class="card-title fw-semibold mb-0">Item Penawaran</legend>
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-offer">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
            <hr />

            <div class="row g-3" id="offers-container">
                @for (int i = 0; i < Model.Offers.Count; i++) 
                {
                    <div class="col-12 offer-row position-relative">
                        <input type="hidden" name="Offers.Index" value="@i" />
                        
                        <div class="mb-1 d-flex gap-3 align-items-end">
                            <div class="w-100">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label class="form-label">Item Penawaran <span class="text-danger">*</span></label>
                                        <input class="form-control" name="Offers[@i].ItemPenawaran" value="@Model.Offers[i].ItemPenawaran" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Qty <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" />
                                    </div>
                                </div>
                            </div>

                            <div>
                                <button type="button" class="btn btn-outline-danger js-remove-offer w-100">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold"><i class="bi bi-card-list text-primary me-1"></i> Body/Detail</legend>
            <hr />
            <div class="mb-3">
                <label asp-for="Description" class="form-label"></label>
                <textarea asp-for="Description" class="form-control" cols="3"></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <div class="row">
                <div class="col-12 col-sm">
                    <div class="mb-3">
                        <label asp-for="XS1" class="form-label">From Location</label>
                        <input type="text" asp-for="XS1" class="form-control" />
                        <span asp-validation-for="XS1" class="text-danger"></span>
                    </div>
                </div>

                <div class="col-12 col-sm">
                    <div class="mb-3">
                        <label asp-for="XS2" class="form-label">Destination</label>
                        <input type="text" asp-for="XS2" class="form-control" />
                        <span asp-validation-for="XS2" class="text-danger"></span>
                    </div>
                </div>
            </div>

            @* Rincian *@
            <div class="mb-3">
                <label asp-for="Note" class="form-label"></label>
                <textarea asp-for="Note" class="form-control" cols="3"></textarea>
                <span asp-validation-for="Note" class="text-danger"></span>
            </div>

            <h3 class="h4 fw-semibold"><i class="bi bi-file-person text-primary me-1"></i> Contact Information</h3>
            <hr />

            <div class="row">
                <div class="col-12 col-sm mb-3">
                    <label asp-for="XS3" class="form-label">Contact Person in location</label>
                    <input type="text" asp-for="XS3" class="form-control" />
                    <span asp-validation-for="XS3" class="text-danger"></span>
                </div>

                <div class="col-12 col-sm mb-3">
                    <label asp-for="XS4" class="form-label">Contact Person in workshop</label>
                    <input type="text" asp-for="XS4" class="form-control" />
                    <span asp-validation-for="XS4" class="text-danger"></span>
                </div>
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <legend class="card-title fw-semibold mb-0">Work Order Details</legend>     
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-detail">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
            <hr />

            <div class="row g-3" id="details-container">
                @for (int i = 0; i < Model.Details?.Count; i++)
                {
                    <div class="col-12 detail-row position-relative">
                        <input type="hidden" name="Details.Index" value="@i" />

                        <div class="mb-1 d-flex gap-3 align-items-end">
                            <div class="w-100">
                                <div class="row g-3">
                                    <div class="col-md-10">
                                        <label class="form-label">Item Name</label>
                                        <input class="form-control" name="Details[@i].ItemName" value="@Model.Details[i].ItemName" />
                                    </div>

                                    <div class="col-md-1">
                                        <label class="form-label">Quantity</label>
                                        <input class="form-control text-end" type="number" min="1" step="1" name="Details[@i].Quantity" value="@Model.Details[i].Quantity" />
                                    </div>

                                    <div class="col-md-1">
                                        <label class="form-label">Unit</label>
                                        <input class="form-control" name="Details[@i].Unit" value="@Model.Details[i].Unit" />
                                    </div>
                                </div>
                            </div>

                            <div>
                                <button type="button" class="btn btn-outline-danger js-remove-detail w-100">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </fieldset>
    </section>

    <section class="card shadow-sm mb-3 p-2 rounded-4">
        <fieldset class="card-body">
            <legend class="card-title fw-semibold"><i class="bi bi-person-check-fill text-primary me-1"></i> Signatures</legend>
            <hr />
            <div class="row gap-2">
                <div class="mb-3 col-12 col-sm d-flex flex-column align-items-center border rounded-4 p-3">
                    <label asp-for="Requester" class="form-label fw-semibold text-info-emphasis"></label>
                    <input type="text" asp-for="Requester" class="form-control w-50 text-center border-2" />
                    <span asp-validation-for="Requester" class="text-danger"></span>
                </div>

                <div class="mb-3 col-12 col-sm d-flex flex-column align-items-center border rounded-4 p-3">
                    <label asp-for="Approved" class="form-label fw-semibold text-info-emphasis"></label>
                    <input type="text" asp-for="Approved" class="form-control w-50 text-center border-2" />
                    <span asp-validation-for="Approved" class="text-danger"></span>
                </div>
            </div>
        </fieldset>
    </section>

    <div class="mb-3 d-flex w-100 justify-content-end">
        <button type="submit" class="btn btn-primary"><i class="bi bi-check2-circle"></i> Save Changes</button>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const detailsContainer = document.getElementById('details-container');
            const btnAddDetail = document.getElementById('btn-add-detail');
            const offersContainer = document.getElementById('offers-container');
            const btnAddOffer = document.getElementById('btn-add-offer');

            function newKey() {
                return Math.random().toString(36).slice(2, 10);
            }

            function detailRowMarkup(key) {
                return `
                    <div class="col-12 detail-row position-relative">
                        <input type="hidden" name="Details.Index" value="${key}" />

                        <div class="row mb-2 align-items-end">
                            <div class="col-md-10">
                                <label class="form-label">Item Name</label>
                                <input class="form-control" name="Details[${key}].ItemName" />
                            </div>

                            <div class="col-md-1">
                                <label class="form-label">Quantity</label>
                                <input class="form-control" type="number" min="1" step="1" name="Details[${key}].Quantity" />
                            </div>

                            <div class="col-md-1">
                                <label class="form-label"> Unit</label>
                                <input class="form-control" name="Details[${key}].Unit" />
                            </div>

                            <div class="col-md-1">
                                <button type="button" class="btn btn-outline-danger js-remove-detail w-100">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            function offerRowMarkup(key) {
                return `
                    <div class="col-12 offer-row position-relative">
                        <input type="hidden" name="Offers.Index" value="${key}" />

                        <div class="mb-3 d-flex gap-3 align-items-end">
                            <div class="w-100">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Item Penawaran</label>
                                        <input class="form-control" name="Offers[${key}].ItemPenawaran" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Qty <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" />
                                    </div>
                                </div>
                            </div>

                            <div>
                                <button type="button" class="btn btn-outline-danger js-remove-offer w-100">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (btnAddDetail) {
                btnAddDetail.addEventListener('click', function () {
                    const key = newKey();
                    detailsContainer.insertAdjacentHTML('beforeend', detailRowMarkup(key));
                    if (window.jQuery && $.validator && $.validator.unobtrusive) {
                        $.validator.unobtrusive.parse(detailsContainer);
                    }
                })
            }

            if (btnAddOffer) {
                btnAddOffer.addEventListener('click', function() {
                    const key = newKey();
                    offersContainer.insertAdjacentHTML('beforeend', offerRowMarkup(key));
                    if (window.jQuery && $.validator && $.validator.unobtrusive) {
                        $.validator.unobtrusive.parse(offersContainer);
                    }
                })
            }

            document.addEventListener('click', function (e) {
                const bntDetail = e.target.closest('.js-remove-detail')
                if (btnDetail) {
                    const row = btnDetail.closest('.detail-row')
                    if (row) row.remove()
                }

                const btnOffer = e.target.closest('.js-remove-offer')
                if (btnOffer) {
                    const row = btnOffer.closest('.offer-row')
                    if (row) row.remove()
                }
            })
        })
    </script>
}
