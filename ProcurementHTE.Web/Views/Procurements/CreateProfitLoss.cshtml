@using Microsoft.AspNetCore.Mvc.Rendering
@using System.Globalization
@using System.Collections.Generic
@using System.Linq
@model ProcurementHTE.Web.Models.ViewModels.ProfitLossInputViewModel
@{
    var isEdit = Model is ProcurementHTE.Web.Models.ViewModels.ProfitLossEditViewModel;
    var editModel = isEdit ? (ProcurementHTE.Web.Models.ViewModels.ProfitLossEditViewModel)Model : null;
    var pageTitle = isEdit ? "Edit Profit & Loss" : "Create Profit & Loss";
    var submitLabel = isEdit ? "Update Profit & Loss" : "Save & Calculate";
    ViewData["Title"] = pageTitle;
    ViewData["DisableHxBoost"] = true;
    var selectedVendorSet = new HashSet<string>(
        Model.SelectedVendorIds ?? new List<string>(),
        StringComparer.OrdinalIgnoreCase
    );
}

<form asp-action="@(isEdit ? "EditProfitLoss" : "CreateProfitLossPost")"
      asp-controller="Procurements"
      method="post"
      id="pl-form"
      class="js-loading-form"
      data-loading-overlay="true"
      hx-boost="false">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="ProcurementId" />
    @if (isEdit && editModel != null)
    {
        <input type="hidden" name="ProfitLossId" value="@editModel.ProfitLossId" />
    }

    <header class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h3 mb-1">@pageTitle</h1>
            <p class="text-muted small mb-0">
                Procurement: <strong>@ViewBag.ProcNum</strong> &middot; Issued: @ViewBag.IssueDate
            </p>
        </div>

        <nav class="d-flex gap-2" aria-label="Page navigation">
            <a asp-action="Details" asp-route-id="@Model.ProcurementId" class="btn btn-outline-secondary" role="button">
                <i class="bi bi-arrow-left"></i> Back to Procurement
            </a>
        </nav>
    </header>

    @if (TempData["WarningMessage"] != null) {
        <div class="alert alert-warning small">@TempData["WarningMessage"]</div>
    }

    <div asp-validation-summary="ModelOnly" class="text-danger small mb-3"></div>

    <div class="row g-3">
        <!-- ================= VENDOR LIST ================= -->
        <section class="col-12" aria-labelledby="vendor-section-title">
            <div class="card shadow-sm p-2">
                <fieldset class="card-body">
                    <legend class="card-title fw-semibold d-flex flex-wrap justify-content-between align-items-center gap-2" id="vendor-section-title">
                        <span>Select Participating Vendors</span>
                        <div class="btn-group btn-group-sm" role="group" aria-label="Vendor selection helpers">
                            <button type="button" class="btn btn-outline-primary" id="btnToggleVendors">
                                <i class="bi bi-check2-square me-1"></i>
                                <span data-label-checked="Uncheck All" data-label-unchecked="Check All">Check All</span>
                            </button>
                        </div>
                    </legend>
                    <p class="text-muted small mb-3">
                        Pilih minimal dua vendor untuk dibandingkan. Tombol <em>Check All</em> akan otomatis menambahkan atau menghapus semua vendor.
                    </p>
                    <hr />
                    <div class="row row-cols-2 row-cols-md-3 g-3">
                        @foreach (var vendor in Model.VendorChoices) {
                            <div class="col mb-2">
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           name="SelectedVendorIds"
                                           value="@vendor.Id"
                                           id="vendor_@vendor.Id" @(selectedVendorSet.Contains(vendor.Id) ? "checked" : null) />
                                    <label class="form-check-label" for="vendor_@vendor.Id">
                                        @vendor.Name
                                    </label>
                                </div>
                            </div>
                        }
                    </div>
                    <span asp-validation-for="SelectedVendorIds" class="text-danger"></span>
                </fieldset>
            </div>
        </section>

        <!-- ================= FINANCIAL SUMMARY ================= -->
        <section class="col-12" aria-labelledby="financial-section-title">
            <div class="card shadow-sm p-2">
                <fieldset class="card-body">
                    <legend class="card-title fw-semibold" id="financial-section-title">Financial Figures</legend>
                    <hr />
                    <div class="row g-3">
                        <!-- Accrual -->
                        <div class="col-md-4">
                            <label asp-for="AccrualAmount" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input asp-for="AccrualAmount" class="form-control text-end" data-format-currency inputmode="numeric" />
                            </div>
                            @* <span class="text-danger" asp-validation-for="AccrualAmount"></span> *@
                        </div>
                        <div class="col-md-4">
                            <label asp-for="RealizationAmount" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input asp-for="RealizationAmount" class="form-control text-end" data-format-currency inputmode="numeric" />
                            </div>
                            @* <span class="text-danger" asp-validation-for="RealizationAmount"></span> *@
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Distance" class="form-label"></label>
                            <input asp-for="Distance" asp-format="{0:0}" class="form-control text-end" inputmode="numeric" />
                            <span class="text-danger" asp-validation-for="Distance"></span>
                        </div>
                    </div>
                </fieldset>
            </div>
        </section>


        <!-- ================= BILLING TO PDC (PER-ITEM) ================= -->
        <section class="col-12" aria-labelledby="pdc-section-title">
            <div class="card shadow-sm">
                <fieldset class="card-body">
                    <legend class="card-title fw-semibold" id="pdc-section-title">Billing to PDC (Revenue Builder per Item)</legend>
                    <hr />
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="min-width:220px">Offer Item</th>
                                    <th class="text-end" style="width:180px">Quantity</th>
                                    <th class="text-end" style="width:180px">400 km Rate</th>
                                    <th class="text-end" style="width:160px">Additional Rate</th>
                                    <th class="text-end" style="width:140px">KM/25</th>
                                    <th class="text-end" style="width:180px">Operator Cost</th>
                                    <th class="text-end" style="width:180px">Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="pdcItems">
                                @for (var i = 0; i < Model.Items.Count; i++) {
                                    var procOfferId = Model.Items[i].ProcOfferId;
                                    var itemName = Model.OfferItems.FirstOrDefault(x => x.ProcOfferId == procOfferId)?.ItemPenawaran;
                                    var quantityItem = Model.OfferItems.FirstOrDefault(item => item.ProcOfferId == procOfferId)?.Quantity;

                                    <tr data-item-row data-proc-offer-id="@procOfferId">
                                        <input type="hidden" name="Items.Index" value="@i" />
                                        <input type="hidden" name="Items[@i].ProcOfferId" value="@procOfferId" />

                                        <td class="fw-semibold">@itemName</td>

                                        <td class="text-end">
                                            <div class="input-group input-group-sm">
                                                @if (isEdit && editModel != null) {
                                                    <input class="form-control text-end"
                                                           asp-for="Items[@i].Quantity"
                                                           data-quantity />
                                                } else {
                                                    <input class="form-control text-end"
                                                           name="Items[@i].Quantity"
                                                           data-quantity
                                                           value="@quantityItem" />
                                                }
                                            </div>
                                            <span class="text-danger small field-validation-valid" asp-validation-for="Items[@i].Quantity"></span>
                                        </td>

                                        <td class="text-end">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">Rp</span>
                                                <input class="form-control text-end"
                                                       asp-for="Items[@i].TarifAwal"
                                                       data-tarif-awal
                                                       data-format-currency 
                                                       autocomplete="off"
                                                       inputmode="numeric" />
                                                @* <span class="text-danger" asp-validation-for="Items[@i].TarifAwal"></span> *@
                                            </div>
                                        </td>

                                        <td class="text-end">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">Rp</span>
                                                <input class="form-control text-end"
                                                       asp-for="Items[@i].TarifAdd"
                                                       data-tarif-add
                                                       data-format-currency
                                                       autocomplete="off"
                                                       inputmode="numeric" />
                                                @* <span class="text-danger" asp-validation-for="Items[@i].TarifAdd"></span> *@
                                            </div>
                                        </td>

                                        <td class="text-end">
                                            <input class="form-control form-control-sm text-end"
                                                   asp-for="Items[@i].KmPer25"
                                                   data-km 
                                                   readonly />
                                        </td>


                                        <td class="text-end">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">Rp</span>
                                                <input class="form-control form-control-sm text-end" data-operator readonly />
                                            </div>
                                        </td>

                                        <td class="text-end">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">Rp</span>
                                                <input class="form-control form-control-sm text-end fw-semibold" data-rev readonly />
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>

                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="6" class="text-end">TOTAL</th>
                                    @* <th class="text-end">
                                        <input id="operatorCost" class="form-control form-control-sm text-end" readonly />
                                    </th> *@
                                    <th class="text-end">
                                        <input id="revenue" class="form-control form-control-sm text-end fw-bold" readonly />
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <small class="text-muted">KM/25 = (Distance - 400) +� 25 <br /> Operator cost per item = <em>Additional Rate +� KM/25</em><br /> Revenue per item = <em>400 km Rate + Operator Cost</em></small>
                </fieldset>
            </div>
        </section>

        <!-- ================= PENAWARAN VENDOR ================= -->
        <section class="col-12" aria-labelledby="offer-section-title">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                        <div>
                            <h3 class="card-title fw-semibold mb-1 h4" id="offer-section-title">Vendor Offers</h3>
                            <p class="text-muted small mb-0">Checklist vendor terlebih dahulu, klik <strong>Add Vendor</strong> untuk membuka satu form dengan daftar vendor terpilih, lalu pilih vendor pada form tersebut sebelum melanjutkan. Tombol expand/collapse membantu mengatur tampilan item.</p>
                        </div>
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddVendor" disabled>
                                <i class="bi bi-person-plus me-1"></i> Add Vendor
                            </button>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Vendor offer layout">
                                <button type="button" class="btn btn-outline-secondary" id="btnExpandVendors">
                                    <i class="bi bi-arrows-expand me-1"></i> Expand All
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="btnCollapseVendors">
                                    <i class="bi bi-arrows-collapse me-1"></i> Collapse All
                                </button>
                            </div>
                        </div>
                    </div>
                    <hr />
                    <div id="vendors" class="vstack gap-3 overflow-auto pe-2"></div>
                </div>
            </div>
        </section>

        <!-- ================= ESTIMASI PERHITUNGAN PROFIT ================= -->
        <section class="col-12" aria-labelledby="summary-section-title">
            <div class="card shadow-sm">
                <fieldset class="card-body">
                    <legend class="card-title fw-semibold" id="summary-section-title">Interim Summary</legend>
                    <hr />
                    <div class="table-responsive border rounded-3">
                        <table class="table align-middle mobile-table" id="summary">
                            <thead class="table-light">
                                <tr>
                                    <th>Vendor</th>
                                    <th class="text-end">Final Offer (+� min / item)</th>
                                    <th class="text-end">Profit</th>
                                    <th class="text-end">Profit %</th>
                                </tr>
                            </thead>
                            <tbody>
                                @* dikosongin, nanti diisi JS recalcSummary *@
                            </tbody>
                        </table>
                    </div>
                </fieldset>
            </div>
        </section>


        <!-- ================= ACTION ================= -->
        <div class="col-12 d-flex justify-content-end gap-2 mb-3">
            <button type="submit" class="btn btn-primary">@submitLabel</button>
        </div>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    @{
        var vendorChoicesJson = System.Text.Json.JsonSerializer.Serialize(
            (Model.VendorChoices ?? System.Linq.Enumerable.Empty<ProcurementHTE.Web.Models.ViewModels.VendorChoiceViewModel>())
                .Select(v => new { id = v.Id, name = v.Name })
        );

        var procItemsJson = System.Text.Json.JsonSerializer.Serialize(
            (Model.OfferItems ?? new System.Collections.Generic.List<ProcurementHTE.Web.Models.ViewModels.ProcOfferLiteVm>())
                .Select(i => new { procOfferId = i.ProcOfferId, itemPenawaran = i.ItemPenawaran, quantity = i.Quantity })
        );

        var vendorPresetJson = System.Text.Json.JsonSerializer.Serialize(
            (Model.Vendors ?? new List<ProcurementHTE.Web.Models.ViewModels.VendorItemOfferInputVm>())
                .Where(v => !string.IsNullOrWhiteSpace(v.VendorId))
                .Select(v => new
                {
                    vendorId = v.VendorId,
                    items = (v.Items ?? new List<ProcurementHTE.Web.Models.ViewModels.VendorOfferPerItemInputVm>())
                        .Select(item => new
                        {
                            procOfferId = item.ProcOfferId,
                            quantity = item.Quantity,
                            trip = item.Trip,
                            prices = item.Prices ?? new List<decimal>(),
                            letters = item.Letters ?? new List<string>()
                        })
                        .ToList()
                })
        );

        var modelStateErrorsJson = System.Text.Json.JsonSerializer.Serialize(
            ViewData.ModelState
                .Where(kvp => kvp.Value?.Errors?.Count > 0)
                .ToDictionary(
                    kvp => kvp.Key,
                    kvp => kvp.Value!.Errors.Select(e => e.ErrorMessage).FirstOrDefault() ?? string.Empty
                )
        );
    }

    <script>
        (function () {
            const vendorsAll = @Html.Raw(vendorChoicesJson);
            const procItems = @Html.Raw(procItemsJson);
            const presetVendors = @Html.Raw(vendorPresetJson);
            const modelStateErrors = @Html.Raw(modelStateErrorsJson);

            const vendorCheckboxSelector = 'input[name="SelectedVendorIds"]';
            const currencySelector = '[data-format-currency]';
            const thousandGroupRegex = /\B(?=(\d{3})+(?!\d))/g;
            const vendorNameMap = new Map((vendorsAll || []).map(v => [v.id, v.name]));
            const vendorsHost = document.getElementById('vendors');
            const addVendorBtn = document.getElementById('btnAddVendor');
            const plForm = document.getElementById('pl-form');
            const distanceInput = document.getElementById('Distance');
            let forcedSubmitInProgress = false;

            const debugLog = (...args) => {
                if (window?.console?.info) {
                    console.info('[PnL]', ...args);
                }
            };
            const debugWarn = (...args) => {
                if (window?.console?.warn) {
                    console.warn('[PnL]', ...args);
                }
            };
            const debugError = (...args) => {
                if (window?.console?.error) {
                    console.error('[PnL]', ...args);
                }
            };
            const enqueueMicrotask = typeof window.queueMicrotask === 'function'
                ? window.queueMicrotask.bind(window)
                : (fn) => Promise.resolve().then(fn);

            const disableJqueryValidation = (form) => {
                if (!window.jQuery || !jQuery.validator || !form) {
                    return;
                }
                const $form = jQuery(form);
                try {
                    $form.removeData('validator');
                    $form.removeData('unobtrusiveValidation');
                } catch {}
                try {
                    $form.off('.validate');
                    $form.find(':input').off('.validate');
                } catch {}
            };

            if (!plForm || !vendorsHost) {
                debugWarn('ProfitLoss script aborted: missing critical DOM nodes', {
                    hasForm: Boolean(plForm),
                    hasVendorsHost: Boolean(vendorsHost)
                });
                return;
            }

            disableJqueryValidation(plForm);

            debugLog('ProfitLoss script initialized', {
                procurementId: plForm.querySelector('input[name="ProcurementId"]')?.value,
                vendorChoiceCount: vendorsAll?.length ?? 0,
                presetVendorCount: presetVendors?.length ?? 0,
                isEdit: Boolean(plForm.querySelector('input[name="ProfitLossId"]'))
            });

            if (window.jQuery && jQuery.validator) {
                const $form = jQuery(plForm);
                $form.removeData('validator');
                $form.removeData('unobtrusiveValidation');
            }

            const instanceKey = '__plCreateEditInstance';
            const previousInstance = window[instanceKey];
            previousInstance?.dispose?.();

            const cleanup = [];
            const registerCleanup = (fn) => {
                if (typeof fn === 'function') {
                    cleanup.push(fn);
                }
            };
            const bind = (target, eventName, handler, options) => {
                if (!target?.addEventListener || typeof handler !== 'function') {
                    return;
                }
                target.addEventListener(eventName, handler, options);
                registerCleanup(() => {
                    try {
                        target.removeEventListener(eventName, handler, options);
                    } catch { /* ignore */ }
                });
            };

            const instance = {
                dispose() {
                    while (cleanup.length) {
                        const dispose = cleanup.pop();
                        try {
                            dispose?.();
                        } catch { /* ignore */ }
                    }
                    if (window[instanceKey] === instance) {
                        delete window[instanceKey];
                    }
                }
            };
            window[instanceKey] = instance;

            bind(document.body, 'htmx:beforeSwap', (event) => {
                const target = event.detail?.target;
                if (target && (target === plForm || target.contains(plForm))) {
                    instance.dispose();
                }
            });

            const digitsOnly = (value) => (value ?? '').toString().replace(/\D/g, '');
            const formatInteger = (value) => {
                const num = Number(value ?? 0);
                if (!Number.isFinite(num)) {
                    return '0';
                }
                return Math.round(num).toLocaleString('id-ID', { maximumFractionDigits: 0 });
            };
            const numberValue = (input) => {
                if (!input) return 0;
                if (input.dataset?.rawValue) {
                    const parsed = parseFloat(input.dataset.rawValue.replace(',', '.'));
                    if (Number.isFinite(parsed)) {
                        return parsed;
                    }
                }
                const digits = digitsOnly(input.value);
                if (digits.length) {
                    const parsed = parseFloat(digits);
                    return Number.isFinite(parsed) ? parsed : 0;
                }
                const fallback = parseFloat((input.value ?? '0').toString().replace(',', '.'));
                return Number.isFinite(fallback) ? fallback : 0;
            };
            const handleCurrencyChange = (input) => {
                if (!input) return;
                if (input.closest('#pdcItems')) {
                    recalcHeader();
                } else if (input.closest('#vendors')) {
                    recalcSummary();
                }
            };
            const setCurrencyDisplay = (input, rawValue) => {
                if (!input) return;
                const normalized = digitsOnly(rawValue ?? input.value);
                input.dataset.rawValue = normalized;
                input.value = normalized ? normalized.replace(thousandGroupRegex, '.') : '';
            };
            const updateCurrencyInput = (input, notify) => {
                if (!input) return;
                const cursorPos = input.selectionStart ?? input.value.length;
                const digitsBefore = input.value.slice(0, cursorPos).replace(/\D/g, '').length;
                setCurrencyDisplay(input, input.value);
                if (document.activeElement === input) {
                    const formatted = input.value;
                    if (!formatted) {
                        input.setSelectionRange(0, 0);
                    } else {
                        let seen = 0;
                        let caret = formatted.length;
                        for (let i = 0; i < formatted.length; i++) {
                            if (/\d/.test(formatted[i])) {
                                seen += 1;
                                if (seen >= digitsBefore) {
                                    caret = i + 1;
                                    break;
                                }
                            }
                        }
                        input.setSelectionRange(caret, caret);
                    }
                }
                if (notify) {
                    handleCurrencyChange(input);
                }
            };
            const bindCurrencyInput = (input) => {
                if (!input || input.dataset.currencyBound === '1') {
                    return;
                }
                input.dataset.currencyBound = '1';
                setCurrencyDisplay(input, input.value);
            };
            const bindCurrencyWithin = (scope) => {
                (scope || document).querySelectorAll(currencySelector).forEach(bindCurrencyInput);
            };
            const setDisplayNumber = (element, value) => {
                if (!element) return;
                const numeric = Number(value ?? 0);
                const sanitized = Number.isFinite(numeric) ? numeric : 0;
                if (element.dataset) {
                    element.dataset.rawValue = sanitized.toString();
                }
                if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    element.value = formatInteger(sanitized);
                } else {
                    element.textContent = formatInteger(sanitized);
                }
            };
            const setKmDisplay = (input, value) => {
                if (!input) return;
                const numeric = Number(value ?? 0);
                const sanitized = Number.isFinite(numeric) ? numeric : 0;
                input.dataset.rawValue = sanitized.toString();
                input.value = formatInteger(sanitized);
            };
            const getKmValue = (input) => {
                if (!input) return 0;
                if (input.dataset?.rawValue) {
                    const parsed = parseFloat(input.dataset.rawValue);
                    return Number.isFinite(parsed) ? parsed : 0;
                }
                const parsed = parseFloat((input.value ?? '0').toString().replace(',', '.'));
                return Number.isFinite(parsed) ? parsed : 0;
            };

            const vendorCards = new Set();
            const vendorAssignments = new Map();
            const presetVendorMap = new Map((presetVendors || []).map(v => [v.vendorId, v]));

            const getSelectedVendorIds = () =>
                Array.from(document.querySelectorAll(`${vendorCheckboxSelector}:checked`)).map(cb => cb.value);
            const getAssignedVendorIds = () => Array.from(vendorAssignments.keys());
            const getAddableVendorIds = () => {
                const selected = new Set(getSelectedVendorIds());
                getAssignedVendorIds().forEach(id => selected.delete(id));
                return Array.from(selected);
            };
            const hasUnassignedCard = () => Array.from(vendorCards).some(card => !card.dataset.vendorId);

            const syncAddVendorButtonState = () => {
                if (!addVendorBtn) return;
                const selectedCount = getSelectedVendorIds().length;
                const available = getAddableVendorIds();
                addVendorBtn.disabled = selectedCount === 0 || available.length === 0 || hasUnassignedCard();
            };

            const refreshVendorSelectOptions = () => {
                const selected = getSelectedVendorIds();
                vendorCards.forEach(card => {
                    const select = card.querySelector('[data-vendor-select]');
                    if (!select) {
                        return;
                    }
                    const current = card.dataset.vendorId || '';
                    select.innerHTML = '';
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = selected.length ? '-- Pilih Vendor --' : 'Tidak ada vendor terpilih';
                    placeholder.disabled = selected.length === 0;
                    placeholder.selected = !current;
                    select.appendChild(placeholder);

                    selected.forEach(id => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = vendorNameMap.get(id) ?? id;
                        if (vendorAssignments.has(id) && card.dataset.vendorId !== id) {
                            option.disabled = true;
                        }
                        if (current === id) {
                            option.selected = true;
                            placeholder.selected = false;
                        }
                        select.appendChild(option);
                    });
                });
            };

            const setVendorItemsCollapsed = (collapsed) => {
                vendorCards.forEach(card => {
                    card.querySelectorAll('[data-vendor-item]').forEach(block => {
                        const body = block.querySelector('[data-item-body]');
                        const toggleBtn = block.querySelector('[data-toggle-item]');
                        if (!body || !toggleBtn) {
                            return;
                        }
                        body.classList.toggle('d-none', collapsed);
                        toggleBtn.innerHTML = collapsed
                            ? '<i class="bi bi-chevron-down"></i>'
                            : '<i class="bi bi-chevron-up"></i>';
                    });
                });
            };

            const buildRoundRow = (block, preset) => {
                const row = document.createElement('div');
                row.className = 'row g-2 align-items-end border rounded-3 p-2';
                row.dataset.roundRow = '1';
                row.innerHTML = `
                    <div class="col-md-5">
                        <label class="form-label">No Letter</label>
                        <input class="form-control form-control-sm" data-letter-input value="${preset?.letter ?? ''}" />
                        <span class="text-danger small field-validation-valid" data-valmsg-letter data-valmsg-replace="true"></span>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">Harga Penawaran</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">Rp</span>
                            <input class="form-control text-end" data-price-input data-format-currency value="${preset?.price ?? ''}" inputmode="numeric" />
                        </div>
                        <span class="text-danger small field-validation-valid" data-valmsg-price data-valmsg-replace="true"></span>
                    </div>
                    <div class="col-md-2 text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm" data-remove-round>
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>`;

                const removeBtn = row.querySelector('[data-remove-round]');
                removeBtn?.addEventListener('click', () => {
                    const host = row.parentElement;
                    row.remove();
                    if (host && host.querySelectorAll('[data-round-row]').length === 0) {
                        host.appendChild(buildRoundRow(block));
                    }
                    reindexVendorCards();
                    recalcSummary();
                });

                const priceInput = row.querySelector('[data-price-input]');
                if (priceInput && preset?.price) {
                    setCurrencyDisplay(priceInput, preset.price.toString());
                }
                bindCurrencyWithin(row);
                row.querySelectorAll('[data-letter-input],[data-price-input]').forEach(input => {
                    input.addEventListener('input', () => {
                        reindexVendorCards();
                        recalcSummary();
                    });
                });
                return row;
            };

            const buildVendorItem = (meta, preset) => {
                const block = document.createElement('div');
                block.className = 'border rounded-3 p-3 bg-body-tertiary';
                block.dataset.vendorItem = '1';
                block.dataset.procOfferId = meta.procOfferId;
                block.dataset.itemName = meta.itemPenawaran;
                block.innerHTML = `
                    <input type="hidden" value="${meta.procOfferId}" data-proc-offer-input />
                    <input type="hidden" data-item-index />
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <div class="fw-semibold">${meta.itemPenawaran}</div>
                            <div class="small text-muted">WO Qty: ${formatInteger(meta.quantity ?? 0)}</div>
                        </div>
                        <div class="hstack gap-1">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-toggle-item>
                                <i class="bi bi-chevron-up"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" data-add-round>
                                <i class="bi bi-plus-circle"></i> Round
                            </button>
                        </div>
                    </div>
                    <div class="mt-3" data-item-body>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Quantity</label>
                                <input class="form-control form-control-sm text-end" data-quantity-input value="${preset?.quantity ?? meta.quantity ?? ''}" inputmode="numeric" />
                                <span class="text-danger small field-validation-valid" data-valmsg-qty data-valmsg-replace="true"></span>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Trip</label>
                                <input class="form-control form-control-sm text-end" data-trip-input value="${preset?.trip ?? ''}" inputmode="numeric" />
                                <span class="text-danger small field-validation-valid" data-valmsg-trip data-valmsg-replace="true"></span>
                            </div>
                        </div>
                        <div class="mt-3 vstack gap-2" data-rounds></div>
                    </div>`;

                const roundsHost = block.querySelector('[data-rounds]');
                const presetRounds = Array.isArray(preset?.prices) && preset.prices.length
                    ? preset.prices.map((price, idx) => ({ price, letter: preset.letters?.[idx] ?? '' }))
                    : [{ price: '', letter: '' }];
                presetRounds.forEach(round => roundsHost.appendChild(buildRoundRow(block, round)));

                block.querySelector('[data-add-round]')?.addEventListener('click', () => {
                    roundsHost.appendChild(buildRoundRow(block));
                    reindexVendorCards();
                });

                const body = block.querySelector('[data-item-body]');
                const toggleBtn = block.querySelector('[data-toggle-item]');
                if (toggleBtn && body) {
                    toggleBtn.addEventListener('click', () => {
                        const collapsed = body.classList.toggle('d-none');
                        toggleBtn.innerHTML = collapsed
                            ? '<i class="bi bi-chevron-down"></i>'
                            : '<i class="bi bi-chevron-up"></i>';
                    });
                }

                block.querySelectorAll('[data-quantity-input],[data-trip-input]').forEach(input => {
                    input.addEventListener('input', () => {
                        reindexVendorCards();
                        recalcSummary();
                    });
                });

                return block;
            };

            const cssEscape = (value) => value ? value.replace(/([:./\[\],])/g, '\\$1') : '';
            const applyModelErrors = () => {
                if (!modelStateErrors || Object.keys(modelStateErrors).length === 0) {
                    return;
                }
                Object.entries(modelStateErrors).forEach(([field, message]) => {
                    const selector = `[data-valmsg-for="${cssEscape(field)}"]`;
                    document.querySelectorAll(selector).forEach(span => {
                        if (!span) return;
                        span.textContent = message;
                        if (message) {
                            span.classList.add('field-validation-error');
                            span.classList.remove('field-validation-valid');
                        } else {
                            span.classList.remove('field-validation-error');
                            span.classList.add('field-validation-valid');
                        }
                    });
                });
            };

            const reindexVendorCards = () => {
                const cards = Array.from(vendorsHost.querySelectorAll('[data-vendor-card]'));
                cards.forEach((card, vendorIdx) => {
                    const vendorHidden = card.querySelector('[data-vendor-id-input]');
                    const vendorId = card.dataset.vendorId || '';
                    if (vendorHidden) {
                        vendorHidden.name = `Vendors[${vendorIdx}].VendorId`;
                        vendorHidden.value = vendorId;
                    }

                    card.querySelectorAll('[data-vendor-item]').forEach((block, itemIdx) => {
                        const base = `Vendors[${vendorIdx}].Items[${itemIdx}]`;
                        const procInput = block.querySelector('[data-proc-offer-input]');
                        const qtyInput = block.querySelector('[data-quantity-input]');
                        const tripInput = block.querySelector('[data-trip-input]');
                        const qtyMsg = block.querySelector('[data-valmsg-qty]');
                        const tripMsg = block.querySelector('[data-valmsg-trip]');
                        if (procInput) procInput.name = `${base}.ProcOfferId`;
                        if (qtyInput) qtyInput.name = `${base}.Quantity`;
                        if (tripInput) tripInput.name = `${base}.Trip`;
                        if (qtyMsg) {
                            qtyMsg.setAttribute('data-valmsg-for', qtyInput?.name ?? '');
                            qtyMsg.dataset.valmsgFor = qtyInput?.name ?? '';
                        }
                        if (tripMsg) {
                            tripMsg.setAttribute('data-valmsg-for', tripInput?.name ?? '');
                            tripMsg.dataset.valmsgFor = tripInput?.name ?? '';
                        }

                        block.querySelectorAll('[data-round-row]').forEach((row, roundIdx) => {
                            const letterInput = row.querySelector('[data-letter-input]');
                            const priceInput = row.querySelector('[data-price-input]');
                            const letterMsg = row.querySelector('[data-valmsg-letter]');
                            const priceMsg = row.querySelector('[data-valmsg-price]');
                            if (letterInput) letterInput.name = `${base}.Letters[${roundIdx}]`;
                            if (priceInput) priceInput.name = `${base}.Prices[${roundIdx}]`;
                            if (letterMsg) {
                                letterMsg.setAttribute('data-valmsg-for', letterInput?.name ?? '');
                                letterMsg.dataset.valmsgFor = letterInput?.name ?? '';
                            }
                            if (priceMsg) {
                                priceMsg.setAttribute('data-valmsg-for', priceInput?.name ?? '');
                                priceMsg.dataset.valmsgFor = priceInput?.name ?? '';
                            }
                        });
                    });
                });
                applyModelErrors();
            };

            const resetVendorCardDisplay = (card) => {
                if (!card) return;
                card.dataset.vendorId = '';
                const hidden = card.querySelector('[data-vendor-id-input]');
                if (hidden) {
                    hidden.value = '';
                }
                const itemsHost = card.querySelector('[data-items-host]');
                if (itemsHost) {
                    itemsHost.innerHTML = '';
                    itemsHost.classList.add('d-none');
                }
                card.querySelector('[data-empty-state]')?.classList.remove('d-none');
                card.querySelector('[data-total-row]')?.classList.add('d-none');
                setDisplayNumber(card.querySelector('[data-vendor-total]'), 0);
            };

            const populateVendorCardItems = (card, preset) => {
                if (!card) return;
                const itemsHost = card.querySelector('[data-items-host]');
                if (!itemsHost) return;
                itemsHost.innerHTML = '';
                (procItems || []).forEach(item => {
                    const presetItem = preset?.items?.find(it => it.procOfferId === item.procOfferId);
                    itemsHost.appendChild(buildVendorItem(item, presetItem));
                });
                card.querySelector('[data-empty-state]')?.classList.add('d-none');
                itemsHost.classList.remove('d-none');
                card.querySelector('[data-total-row]')?.classList.remove('d-none');
                bindCurrencyWithin(itemsHost);
                setVendorItemsCollapsed(false);
            };

            const assignVendorToCard = (card, vendorId, preset) => {
                if (!card) return;
                const select = card.querySelector('[data-vendor-select]');
                const previousVendor = card.dataset.vendorId || '';
                if (vendorId === previousVendor) {
                    return;
                }

                if (vendorId && vendorAssignments.has(vendorId) && vendorAssignments.get(vendorId) !== card) {
                    if (window.Swal?.fire) {
                        window.Swal.fire({
                            icon: 'info',
                            title: 'Vendor sudah digunakan',
                            text: 'Vendor tersebut sudah memiliki form penawaran.'
                        });
                    } else {
                        alert('Vendor tersebut sudah memiliki form penawaran.');
                    }
                    if (select) {
                        select.value = previousVendor || '';
                    }
                    return;
                }

                if (previousVendor) {
                    vendorAssignments.delete(previousVendor);
                }

                if (!vendorId) {
                    resetVendorCardDisplay(card);
                    refreshVendorSelectOptions();
                    syncAddVendorButtonState();
                    reindexVendorCards();
                    recalcSummary();
                    return;
                }

                vendorAssignments.set(vendorId, card);
                card.dataset.vendorId = vendorId;
                if (select && select.value !== vendorId) {
                    select.value = vendorId;
                }
                const hidden = card.querySelector('[data-vendor-id-input]');
                if (hidden) {
                    hidden.value = vendorId;
                }
                populateVendorCardItems(card, preset ?? presetVendorMap.get(vendorId));
                refreshVendorSelectOptions();
                syncAddVendorButtonState();
                reindexVendorCards();
                recalcSummary();
            };

            const removeVendorCard = (card, options = {}) => {
                if (!card) return;
                const vendorId = card.dataset.vendorId;
                if (vendorId) {
                    vendorAssignments.delete(vendorId);
                    if (options.uncheckVendor !== false) {
                        const checkbox = document.getElementById(`vendor_${vendorId}`);
                        if (checkbox) {
                            checkbox.checked = false;
                        }
                    }
                }
                vendorCards.delete(card);
                card.remove();
                reindexVendorCards();
                recalcSummary();
                refreshVendorSelectOptions();
                syncAddVendorButtonState();
            };

            const createVendorCard = (options = {}) => {
                const card = document.createElement('div');
                card.className = 'card border border-primary-subtle';
                card.dataset.vendorCard = '1';
                card.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="flex-grow-1">
                            <label class="form-label small text-uppercase mb-1 fw-semibold">Vendor Penawaran</label>
                            <select class="form-select form-select-sm" data-vendor-select>
                                <option value="">-- Pilih Vendor --</option>
                            </select>
                            <div class="small text-muted">Hanya vendor yang tercentang yang akan muncul di daftar.</div>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" data-remove-vendor>
                            <i class="bi bi-trash"></i> Hapus
                        </button>
                    </div>
                    <div class="card-body vstack gap-3">
                        <input type="hidden" data-vendor-index />
                        <input type="hidden" data-vendor-id-input />
                        <div class="alert alert-info small mb-0" data-empty-state>Pilih vendor untuk menampilkan detail penawaran.</div>
                        <div class="vstack gap-3 d-none" data-items-host></div>
                        <div class="d-flex justify-content-end gap-3 align-items-center border-top pt-2 d-none" data-total-row>
                            <div class="fw-semibold">Final Offer</div>
                            <span class="fw-bold" data-vendor-total>0</span>
                        </div>
                    </div>`;

                vendorsHost.appendChild(card);
                vendorCards.add(card);
                resetVendorCardDisplay(card);

                const vendorSelect = card.querySelector('[data-vendor-select]');
                bind(vendorSelect, 'change', () => {
                    const selectedVendorId = vendorSelect.value || '';
                    assignVendorToCard(card, selectedVendorId, presetVendorMap.get(selectedVendorId));
                });

                card.querySelector('[data-remove-vendor]')?.addEventListener('click', () => removeVendorCard(card, { uncheckVendor: false }));

                refreshVendorSelectOptions();
                syncAddVendorButtonState();

                if (options.vendorId) {
                    assignVendorToCard(card, options.vendorId, options.preset ?? presetVendorMap.get(options.vendorId));
                }

                return card;
            };

            const computeVendorFinalOffer = (card) => {
                if (!card) return 0;
                let total = 0;
                card.querySelectorAll('[data-vendor-item]').forEach(block => {
                    const qty = numberValue(block.querySelector('[data-quantity-input]'));
                    const trip = numberValue(block.querySelector('[data-trip-input]'));
                    if (qty <= 0 || trip <= 0) return;
                    let finalPrice = Number.POSITIVE_INFINITY;
                    block.querySelectorAll('[data-price-input]').forEach(priceInput => {
                        const price = numberValue(priceInput);
                        if (price > 0 && price < finalPrice) {
                            finalPrice = price;
                        }
                    });
                    if (Number.isFinite(finalPrice) && finalPrice > 0) {
                        total += finalPrice * qty * trip;
                    }
                });
                return total;
            };

            const recalcSummary = () => {
                const revenueField = document.getElementById('revenue');
                const revenue = revenueField?.dataset?.rawValue
                    ? parseFloat(revenueField.dataset.rawValue)
                    : parseFloat(digitsOnly(revenueField?.value)) || 0;
                const tbody = document.querySelector('#summary tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                }

                const snapshot = [];
                vendorAssignments.forEach((card, vendorId) => {
                    const total = computeVendorFinalOffer(card);
                    setDisplayNumber(card.querySelector('[data-vendor-total]'), total);
                    if (!tbody || total <= 0) return;

                    const vendorName = vendorNameMap.get(vendorId) ?? vendorId;
                    const profit = revenue - total;
                    const pct = revenue > 0 ? (profit / revenue) * 100 : 0;
                    const pctDisplay = Math.round(pct);

                    snapshot.push({ vendorId, vendorName, total, profit, pct });

                    const tr = document.createElement('tr');
                    tr.dataset.totalRaw = total.toString();
                    tr.innerHTML = `
                        <td>${vendorName}</td>
                        <td class="text-end">${formatInteger(total)}</td>
                        <td class="text-end">${formatInteger(profit)}</td>
                        <td class="text-end">${pctDisplay}%</td>`;
                    tbody.appendChild(tr);
                });

                if (tbody) {
                    const rows = [...tbody.querySelectorAll('tr')];
                    rows.forEach(row => row.classList.remove('table-success'));
                    if (rows.length) {
                        const best = rows.reduce((acc, row) => {
                            const accVal = parseFloat(acc.dataset.totalRaw || '0') || 0;
                            const rowVal = parseFloat(row.dataset.totalRaw || '0') || 0;
                            return rowVal < accVal ? row : acc;
                        }, rows[0]);
                        best.classList.add('table-success');
                    }
                }

                if (snapshot.length) {
                    debugLog('Interim summary recalculated', {
                        revenue,
                        vendorCount: snapshot.length,
                        rows: snapshot,
                    });
                } else {
                    debugLog('Interim summary cleared (no vendor data)', { revenue });
                }
            };

            const recalcHeader = () => {
                const distance = parseFloat(distanceInput?.value?.toString().replace(',', '.') ?? '0') || 0;
                let revenueSum = 0;
                const itemSnapshots = [];
                document.querySelectorAll('#pdcItems [data-item-row]').forEach(row => {
                    const qty = numberValue(row.querySelector('[data-quantity]'));
                    const tarifAwal = numberValue(row.querySelector('[data-tarif-awal]'));
                    const tarifAdd = numberValue(row.querySelector('[data-tarif-add]'));
                    const kmInput = row.querySelector('[data-km]');
                    let km = 0;
                    if (distance > 400) {
                        km = Math.max(0, (distance - 400) / 25);
                        setKmDisplay(kmInput, km);
                    } else if (kmInput) {
                        km = getKmValue(kmInput);
                    }

                    const operatorCost = tarifAdd * km;
                    const revenue = (tarifAwal + operatorCost) * qty;

                    setDisplayNumber(row.querySelector('[data-operator]'), operatorCost);
                    setDisplayNumber(row.querySelector('[data-rev]'), revenue);

                    revenueSum += revenue;

                    itemSnapshots.push({
                        procOfferId: row.dataset.procOfferId,
                        qty,
                        tarifAwal,
                        tarifAdd,
                        km,
                        operatorCost,
                        revenue,
                    });
                });

                setDisplayNumber(document.getElementById('revenue'), revenueSum);
                debugLog('Header totals recalculated', {
                    distance,
                    revenue: revenueSum,
                    items: itemSnapshots,
                });
                recalcSummary();
            };

            const recalcKmPer25FromDistance = () => {
                if (!distanceInput) {
                    recalcHeader();
                    return;
                }
                const distance = parseFloat(distanceInput.value.toString().replace(',', '.') || '0') || 0;
                const kmValue = distance > 400 ? Math.max(0, (distance - 400) / 25) : 0;
                document.querySelectorAll('[data-km]').forEach(input => setKmDisplay(input, kmValue));
                recalcHeader();
            };

            const validateVendorCoverage = () => {
                const errors = [];
                const participatingVendors = Array.from(vendorAssignments.keys());

                vendorCards.forEach(card => {
                    if (!card.dataset.vendorId) {
                        errors.push('Ada form Vendor Offer tanpa vendor terpilih. Mohon pilih vendor atau hapus form tersebut.');
                    }
                });

                if (!participatingVendors.length) {
                    errors.push('Minimal satu vendor harus mengirim penawaran lengkap.');
                }

                vendorAssignments.forEach((card, vendorId) => {
                    const vendorName = vendorNameMap.get(vendorId) ?? vendorId;
                    card.querySelectorAll('[data-vendor-item]').forEach(block => {
                        const itemName = block.dataset.itemName ?? block.dataset.procOfferId ?? 'Item';
                        const qty = numberValue(block.querySelector('[data-quantity-input]'));
                        const trip = numberValue(block.querySelector('[data-trip-input]'));
                        const hasPrice = [...block.querySelectorAll('[data-price-input]')].some(input => numberValue(input) > 0);
                        if (qty <= 0 || trip <= 0 || !hasPrice) {
                            errors.push(`${vendorName} - ${itemName}: lengkapi quantity, trip, dan minimal satu harga.`);
                        }
                    });
                });

                if (errors.length) {
                    debugWarn('Vendor coverage blocked submission', {
                        errors,
                        participatingVendors
                    });
                    if (window.Swal?.fire) {
                        window.Swal.fire({
                            icon: 'warning',
                            title: 'Lengkapi Penawaran Vendor',
                            html: errors.map(e => `• ${e}`).join('<br/>')
                        });
                    } else {
                        alert('Lengkapi penawaran vendor berikut:\n- ' + errors.join('\n- '));
                    }
                    return false;
                }
                return true;
            };

            const syncToggleButtonLabel = () => {
                const toggleVendorBtn = document.getElementById('btnToggleVendors');
                if (!toggleVendorBtn) return;
                const checkboxes = Array.from(document.querySelectorAll(vendorCheckboxSelector)).filter(cb => !cb.disabled);
                const allChecked = checkboxes.length > 0 && checkboxes.every(cb => cb.checked);
                const labelSpan = toggleVendorBtn.querySelector('span[data-label-checked]');
                if (labelSpan) {
                    labelSpan.textContent = allChecked
                        ? labelSpan.getAttribute('data-label-checked') ?? 'Uncheck All'
                        : labelSpan.getAttribute('data-label-unchecked') ?? 'Check All';
                }
                const icon = toggleVendorBtn.querySelector('i');
                if (icon) {
                    icon.className = allChecked ? 'bi bi-square me-1' : 'bi bi-check2-square me-1';
                }
            };

            document.getElementById('btnToggleVendors')?.addEventListener('click', () => {
                const checkboxes = Array.from(document.querySelectorAll(vendorCheckboxSelector)).filter(cb => !cb.disabled);
                const shouldCheckAll = !(checkboxes.length > 0 && checkboxes.every(cb => cb.checked));
                checkboxes.forEach(cb => {
                    cb.checked = shouldCheckAll;
                    cb.dispatchEvent(new Event('change'));
                });
                syncToggleButtonLabel();
                syncAddVendorButtonState();
            });

            document.getElementById('btnExpandVendors')?.addEventListener('click', () => setVendorItemsCollapsed(false));
            document.getElementById('btnCollapseVendors')?.addEventListener('click', () => setVendorItemsCollapsed(true));

            document.querySelectorAll(vendorCheckboxSelector).forEach(cb => {
                cb.addEventListener('change', () => {
                    if (!cb.checked) {
                        const card = vendorAssignments.get(cb.value);
                        if (card) {
                            removeVendorCard(card, { uncheckVendor: false });
                        }
                    }
                    syncToggleButtonLabel();
                    refreshVendorSelectOptions();
                    syncAddVendorButtonState();
                });
            });

            addVendorBtn?.addEventListener('click', () => {
                if (addVendorBtn.disabled) {
                    return;
                }
                if (!getAddableVendorIds().length) {
                    syncAddVendorButtonState();
                    return;
                }
                const card = createVendorCard();
                const select = card.querySelector('[data-vendor-select]');
                select?.focus();
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });

            bind(plForm, 'submit', (event) => {
                if (forcedSubmitInProgress) {
                    debugLog('Skipping instrumentation for forced submission replay');
                    return;
                }
                const selectedVendorIds = getSelectedVendorIds();
                debugLog('Form submit triggered', {
                    action: plForm.action,
                    method: plForm.method,
                    selectedVendorCount: selectedVendorIds.length,
                    vendorCards: vendorCards.size,
                    viaHtmxBoost: plForm.closest('#app-content')?.getAttribute('hx-boost'),
                    defaultPrevented: event.defaultPrevented
                });
                if (!validateVendorCoverage()) {
                    debugWarn('Submission cancelled by client-side validation');
                    event.preventDefault();
                    event.stopPropagation();
                    return;
                }
                document.querySelectorAll(currencySelector).forEach(input => {
                    input.value = input.dataset?.rawValue ?? digitsOnly(input.value);
                });
                debugLog('Currency fields normalized before submit');
                enqueueMicrotask(() => {
                    const prevented = event.defaultPrevented;
                    debugLog('Submit bubble completed', { defaultPrevented: prevented });
                    if (!prevented) {
                        return;
                    }
                    if (!plForm.checkValidity()) {
                        debugWarn('Submit prevented by browser validity; not forcing manual submit');
                        return;
                    }
                    debugWarn('Submit was prevented by another handler. Forcing manual submit replay.');
                    forcedSubmitInProgress = true;
                    try {
                        plForm.submit();
                    } finally {
                        forcedSubmitInProgress = false;
                    }
                });
            });

            if (window.htmx) {
                bind(document.body, 'htmx:beforeRequest', (event) => {
                    const sourceElement = event.detail?.elt;
                    const originForm = sourceElement?.closest?.('form');
                    if (originForm === plForm) {
                        debugLog('HTMX beforeRequest', {
                            path: event.detail?.pathInfo,
                            verb: event.detail?.verb,
                            boosted: event.detail?.boosted,
                            headers: event.detail?.headers
                        });
                    }
                });
                bind(document.body, 'htmx:afterRequest', (event) => {
                    const sourceElement = event.detail?.elt;
                    const originForm = sourceElement?.closest?.('form');
                    if (originForm === plForm) {
                        debugLog('HTMX afterRequest', {
                            status: event.detail?.xhr?.status,
                            path: event.detail?.pathInfo
                        });
                    }
                });
                bind(document.body, 'htmx:responseError', (event) => {
                    const sourceElement = event.detail?.elt;
                    const originForm = sourceElement?.closest?.('form');
                    if (originForm === plForm) {
                        debugError('HTMX response error', {
                            status: event.detail?.xhr?.status,
                            path: event.detail?.pathInfo,
                            error: event.detail?.error
                        });
                    }
                });
            } else {
                debugWarn('HTMX instance not detected while wiring debug hooks');
            }

            bind(document, 'input', (event) => {
                const target = event.target;
                if (!target) return;
                if (target.matches(currencySelector)) {
                    updateCurrencyInput(target, true);
                } else if (target.matches('[data-quantity],[data-km]')) {
                    recalcHeader();
                } else if (target.matches('[data-quantity-input],[data-trip-input]')) {
                    recalcSummary();
                }
            });
            bind(document, 'blur', (event) => {
                if (event.target?.matches(currencySelector)) {
                    updateCurrencyInput(event.target);
                }
            }, true);

            const initPresetVendors = () => {
                if (!Array.isArray(presetVendors)) {
                    return;
                }
                presetVendors.forEach(vendor => {
                    if (!vendor?.vendorId) return;
                    const checkbox = document.getElementById(`vendor_${vendor.vendorId}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                    createVendorCard({ vendorId: vendor.vendorId, preset: vendor });
                });
            };

            bindCurrencyWithin(document);
            if (distanceInput) {
                bind(distanceInput, 'input', recalcKmPer25FromDistance);
                bind(distanceInput, 'change', recalcKmPer25FromDistance);
            }

            initPresetVendors();
            refreshVendorSelectOptions();
            syncToggleButtonLabel();
            syncAddVendorButtonState();
            recalcKmPer25FromDistance();
            reindexVendorCards();
        })();
    </script>
}
