@using Microsoft.AspNetCore.Authorization
@using ProcurementHTE.Core.Common
@using ProcurementHTE.Core.Models
@using ProcurementHTE.Core.Authorization
@using System.Linq
@using System.Collections.Generic
@model PagedResult<Procurement>
@inject IAuthorizationService AuthZ
@{
    ViewData["Title"] = "Procurements Data";
    var canCreate = await AuthZ.AuthorizeAsync(User, Permissions.Procurement.Create);
    var canEdit = await AuthZ.AuthorizeAsync(User, Permissions.Procurement.Edit);
    var canDelete = await AuthZ.AuthorizeAsync(User, Permissions.Procurement.Delete);
    bool isManager = (await AuthZ.AuthorizeAsync(User, "AtLeast.Manager")).Succeeded || User.IsInRole("Admin");
    Func<string, string> BadgeClass = s => (s ?? "").ToLower() switch {
        "draft" => "bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle",
        "created" => "bg-info-subtle text-info-emphasis border border-info-subtle",
        "completed" => "bg-success-subtle text-success-emphasis border border-success-subtle",
        "closed" => "bg-warning-subtle text-warning-emphasis border border-warning-subtle",
        _ => "bg-light text-body border"
    };
    var currentSearch = Context.Request.Query["search"].ToString();
    var currentFields = (Context.Request.Query["fields"].ToString() ?? "ProcNum,JobName")
        .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
        .ToHashSet(StringComparer.OrdinalIgnoreCase);
    var columns = new (string Key, string Label)[] {
        ("ProcNum","Procurement No."),
        ("Wonum","WO Number"),
        ("JobName","Job Name"),
        ("JobType","Job Type"),
        ("SelectedVendorName","Vendor"),
        ("Status","Status"),
    };
    var pageSize = Model.PageSize;
    Func<decimal?, string> formatMoney = value => value.HasValue ? value.Value.ToString("N0") : "-";
    var userNames = ViewBag.UserNames as IDictionary<string, string> ?? new Dictionary<string, string>();
    Func<string?, string> resolveUserName = id =>
    {
        if (string.IsNullOrWhiteSpace(id))
            return "-";
        return userNames.TryGetValue(id, out var name) ? name : id;
    };
}

<header class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Procurements</h1>
    <a asp-action="SelectType" class="btn btn-outline-primary" role="button"><i class="bi bi-plus-circle"></i> Create New</a>
</header>

<form method="get" id="filterForm" class="border rounded-3 d-flex flex-wrap gap-2 p-2 mb-2">
    <button type="button" class="btn btn-outline-secondary" id="btnRefresh"><i class="bi bi-arrow-clockwise"></i> Refresh</button>

    <div class="input-group w-auto">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input class="form-control" type="search" name="search" id="searchBox" placeholder="Type to search..." value="@currentSearch" />
    </div>

    <div class="dropdown ms-sm-auto">
        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-funnel"></i> Filter
        </button>

        <div class="dropdown-menu p-3">
            <div class="mb-2 fw-semibold small text-muted">Search in columns</div>

            @foreach (var col in columns) {
                var checkedAttr = currentFields.Contains(col.Key) ? "Checked" : null;
                <div class="form-check">
                    <input type="checkbox" class="form-check-input filter-col" value="@col.Key" id="col_@col.Key" @checkedAttr />
                    <label for="col_@col.Key" class="form-check-label">@col.Label</label>
                </div>
            }
            
            <div class="d-grid mt-3">
                <button type="button" class="btn btn-primary btn-sm" id="btnApplyFilter">Apply</button>
            </div>
        </div>
    </div>

    <input type="hidden" name="fields" id="fieldsHidden" value="@string.Join(",", currentFields)" />
    <input type="hidden" name="page" id="pageHidden" value="@Model.Page" />
    <input type="hidden" name="pageSize" id="pageSizeHidden" value="@pageSize" />

    @* <button type="button" class="btn btn-outline-secondary ms-auto"><i class="bi bi-funnel me-1"></i> Filter</button> *@
</form>

<div class="table-responsive border rounded-3">
    <table class="table table-hover align-middle mobile-table">
        <thead class="table-light">
            <tr class="align-middle">
                <th class="border-end">Job Name</th>
                <th class="border-end">WO Number</th>
                <th class="border-end">Start Date</th>
                <th class="border-end">Job Type</th>
                <th class="border-end text-end">Revenue</th>
                <th class="border-end text-end">Cost</th>
                <th class="border-end text-end">Profit %</th>
                <th class="border-end">Vendor</th>
                <th class="border-end">Project Region</th>
                <th class="border-end text-center">PIC Ops</th>
                <th class="border-end text-center">Analyst</th>
                <th class="border-end text-center">Asst. Manager</th>
                <th class="border-end text-center">Manager</th>
                <th class="text-center">Action</th>

            </tr>
        </thead>

        <tbody>
            @if (Model == null || !Model.Items.Any()) {
                <tr>
                    <td colspan="13" class="text-center text-muted">No Procurement data found</td>
                </tr>
            } else {
                foreach (var item in Model.Items) {
                    var latestPnl = item.ProfitLosses?
                        .OrderByDescending(p => p.CreatedAt)
                        .FirstOrDefault();
                    var revenue = latestPnl?.AccrualAmount;
                    var cost = latestPnl?.RealizationAmount;
                    var profitPercent = latestPnl != null
                        ? latestPnl.ProfitPercent.ToString("0.##")
                        : "-";
                    var vendorName = latestPnl?.SelectedVendor?.VendorName
                        ?? (!string.IsNullOrWhiteSpace(latestPnl?.SelectedVendorId) ? latestPnl!.SelectedVendorId : null)
                        ?? "-";
                    var region = item.ProjectRegion.ToString();
                    var wonum = string.IsNullOrWhiteSpace(item.Wonum) ? "-" : item.Wonum;
                    var picOps = resolveUserName(item.PicOpsUserId);
                    var analyst = resolveUserName(item.AnalystHteUserId);
                    var assistant = resolveUserName(item.AssistantManagerUserId);
                    var manager = resolveUserName(item.ManagerUserId);

                    <tr>
                        <td class="d-flex d-sm-table-cell" data-label="Job Name">
                            @item.JobName
                        </td>
                        <td class="d-flex d-sm-table-cell" data-label="WO Number">
                            @wonum
                        </td>
                        <td class="d-flex d-sm-table-cell" data-label="Start Date">
                            @(item.StartDate == default ? "-" : item.StartDate.ToString("dd MMM yyyy"))
                        </td>
                        <td class="d-flex d-sm-table-cell" data-label="Job Type">
                            @(item.JobType?.TypeName ?? "-")
                        </td>
                        <td class="d-flex d-sm-table-cell" data-label="Revenue">
                            @formatMoney(revenue)
                        </td>
                        <td class="d-flex d-sm-table-cell" data-label="Cost">
                            @formatMoney(cost)
                        </td>
                        <td class="d-flex d-sm-table-cell" data-label="Profit %">
                            @profitPercent
                        </td>
                        <td class="d-flex d-sm-table-cell" data-label="Vendor">
                            @vendorName
                        </td>
                        <td class="d-flex d-sm-table-cell" data-label="Project Region">
                            @(!string.IsNullOrWhiteSpace(region) ? region : "-")
                        </td>
                        <td class="text-center d-flex d-sm-table-cell" data-label="PIC Ops">
                            @picOps
                        </td>
                        <td class="text-center d-flex d-sm-table-cell" data-label="Analyst">
                            @analyst
                        </td>
                        <td class="text-center d-flex d-sm-table-cell" data-label="Asst. Manager">
                            @assistant
                        </td>
                        <td class="text-center d-flex d-sm-table-cell" data-label="Manager">
                            @manager
                        </td>
                        <td class="text-md-center d-flex d-sm-table-cell" data-label="Action">
                            <a class="link-warning link-opacity-50-hover text-decoration-none me-2" asp-action="Edit" asp-route-id="@item.ProcurementId" role="button">
                                <span class="visually-hidden">Edit</span>
                                <i class="bi bi-pencil-fill"></i>
                            </a>
                            <a class="link-info link-opacity-50-hover text-decoration-none me-2" asp-action="Details" asp-route-id="@item.ProcurementId" role="button">
                                <span class="visually-hidden">Detail</span>
                                <i class="bi bi-eye-fill"></i>
                            </a>
                            @if (canDelete.Succeeded)
                            {
                                <button type="button"
                                        class="btn btn-link p-0 border-0 link-danger link-opacity-50-hover text-decoration-none me-2 js-delete-procurement"
                                        data-procurement-id="@item.ProcurementId"
                                        data-wo-number="@(string.IsNullOrWhiteSpace(item.Wonum) ? "-" : item.Wonum)"
                                        data-job-name="@item.JobName">
                                    <span class="visually-hidden">Delete</span>
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@if (canDelete.Succeeded)
{
    <form asp-action="Delete" method="post" id="deleteProcurementForm" class="d-none">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" id="deleteProcurementFormId" />
    </form>
}

@await Html.PartialAsync("_Pager", Model)

@section Scripts {
    <script>
        (function () {
            const form = document.getElementById('filterForm');
            const searchBox = document.getElementById('searchBox');
            const fieldsHidden = document.getElementById('fieldsHidden');
            const pageHidden = document.getElementById('pageHidden');
            const pageSizeHidden = document.getElementById('pageSizeHidden');

            // Apply: ambil kolom tercentang, reset page ke 1, submit
            document.getElementById('btnApplyFilter').addEventListener('click', function () {
                const cols = Array.from(document.querySelectorAll('.filter-col:checked')).map(c => c.value);
                fieldsHidden.value = cols.join(',');
                pageHidden.value = 1;
                form.submit();
            });

            // Enter di search langsung submit (page reset ke 1)
            searchBox.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    pageHidden.value = 1;
                    form.submit();
                }
            });

            // Refresh: hapus search & kolom, reset page ke 1 & submit
            document.getElementById('btnRefresh').addEventListener('click', function () {
                searchBox.value = '';
                fieldsHidden.value = ''; // pakai default di Controller kalau kosong
                pageHidden.value = 1;
                form.submit();
            });

            const deleteButtons = document.querySelectorAll('.js-delete-procurement');
            const deleteForm = document.getElementById('deleteProcurementForm');
            const deleteIdInput = document.getElementById('deleteProcurementFormId');

            if (deleteButtons.length && deleteForm && deleteIdInput && window.Swal) {
                deleteButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const procId = button.getAttribute('data-procurement-id');
                        const woNumber = button.getAttribute('data-wo-number') || 'WO Number -';
                        const jobName = button.getAttribute('data-job-name') || '';

                        Swal.fire({
                            icon: 'warning',
                            title: `Delete ${woNumber}?`,
                            html: jobName ? `<div class="text-muted">${jobName}</div>` : '',
                            showCancelButton: true,
                            confirmButtonText: 'Delete',
                            cancelButtonText: 'Cancel',
                            confirmButtonColor: '#dc3545',
                            cancelButtonColor: '#6c757d',
                            focusCancel: true
                        }).then(result => {
                            if (result.isConfirmed) {
                                deleteIdInput.value = procId;
                                deleteForm.submit();
                            }
                        });
                    });
                });
            }
        })();
    </script>
}
