@model ProcurementHTE.Web.Models.ViewModels.ProfitLossInputViewModel
@{
    ViewData["Title"] = "Input Profit & Loss";
}

<div class="card shadow-sm">
    <div class="card-body">
        <h5 class="mb-3">Tagihan ke PDC (Revenue Builder)</h5>
        <form asp-action="Create" method="post" id="pl-form">
            <input type="hidden" asp-for="WorkOrderId" />
    <div asp-validation-summary="All" class="text-danger small mb-3"></div>


            <h5>Pilih Vendor yang Diikutkan</h5>
            <div class="row row-cols-2 row-cols-md-3">
                @foreach (var vendor in Model.VendorChoices) {
                    <div class="col mb-2">
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   name="SelectedVendorIds"
                                   value="@vendor.Id"
                                   id="vendor_@vendor.Id" />
                            <label class="form-check-label" for="vendor_@vendor.Id">
                                @vendor.Name
                            </label>
                        </div>
                    </div>
                }
            </div>

            <hr />

            <div class="row g-3">
                <div class="col-md-4">
                    <label asp-for="TarifAwal" class="form-label"></label>
                    <input asp-for="TarifAwal" class="form-control text-end" />
                    <span asp-validation-for="TarifAwal" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="TarifAdd" class="form-label"></label>
                    <input asp-for="TarifAdd" class="form-control text-end" />
                    <span asp-validation-for="TarifAdd" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="KmPer25" class="form-label"></label>
                    <input asp-for="KmPer25" class="form-control text-end" />
                    <span asp-validation-for="KmPer25" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Operator Cost (TarifAdd × Km/25)</label>
                    <input id="operatorCost" class="form-control text-end" readonly />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Revenue</label>
                    <input id="revenue" class="form-control text-end fw-bold" readonly />
                </div>
            </div>

            <hr class="my-4" />
            <h5 class="mb-2">Penawaran Vendor</h5>
            <div id="vendors" class="vstack gap-3"></div>
            <div class="mt-2">
                <button type="button" class="btn btn-outline-primary" id="btnAddVendor">
                    <i class="bi bi-person-plus"></i> Tambah Vendor
                </button>
            </div>

            <hr class="my-4" />
            <h6 class="mb-2">Ringkasan Sementara</h6>
            <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle" id="summary">
                    <thead class="table-light">
                        <tr>
                            <th>Vendor</th>
                            <th class="text-end">Final Offer</th>
                            <th class="text-end">Profit</th>
                            <th class="text-end">Profit %</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="d-flex justify-content-end gap-2">
                <a asp-action="Details" asp-route-workOrderId="@Model.WorkOrderId" class="btn btn-light">Lihat Hasil</a>
                <button type="submit" class="btn btn-primary">Simpan & Hitung</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
  <partial name="_ValidationScriptsPartial" />
  <script>
    // ========= Data dari server =========
    const vendorChoices = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.VendorChoices.Select(v => new { id = v.Id, name = v.Name })
    ));

    // ========= Helpers UI =========
    const fmt = n => (Number(n || 0)).toLocaleString('id-ID');
    const vendorsContainer = document.getElementById('vendors');

    function recalcHeader() {
      const tarifAwal = parseFloat(document.getElementById('TarifAwal').value || 0);
      const tarifAdd  = parseFloat(document.getElementById('TarifAdd').value || 0);
      const km        = parseInt(document.getElementById('KmPer25').value || 0);
      const opCost    = tarifAdd * km;
      const revenue   = tarifAwal + opCost;
      document.getElementById('operatorCost').value = fmt(opCost);
      document.getElementById('revenue').value = fmt(revenue);
      recalcSummary();
    }
    ['TarifAwal','TarifAdd','KmPer25'].forEach(id =>
      document.getElementById(id).addEventListener('input', recalcHeader)
    );

    // --- vendor terpilih via checkbox & vendor yang sudah dipakai blok ---
    function getSelectedVendorIds() {
      return Array.from(document.querySelectorAll('input[name="SelectedVendorIds"]:checked'))
        .map(cb => cb.value);
    }
    function getOfferedVendorIds() {
      return Array.from(vendorsContainer.querySelectorAll('input[type="hidden"][name$=".VendorId"]'))
        .map(h => h.value).filter(Boolean);
    }

    // --- opsi untuk satu picker: hanya vendor terpilih, minus yang sudah dipakai blok lain ---
    function buildAllowedOptionsForCard(currentCardVendorId = null) {
      const selected = new Set(getSelectedVendorIds());
      const used     = new Set(getOfferedVendorIds());
      if (currentCardVendorId) used.delete(currentCardVendorId); // keep current vendor of this card
      return vendorChoices.filter(v => selected.has(v.id) && !used.has(v.id));
    }

    // ========= Searchable Picker (tanpa plugin) =========
    // Struktur:
    // <div class="vendor-picker">
    //   <input type="hidden" name="Vendors[i].VendorId" value="...">
    //   <div class="position-relative">
    //     <input type="text" class="form-control vendor-search" placeholder="Cari / pilih vendor">
    //     <div class="dropdown-menu vendor-panel">... opsi ...</div>
    //   </div>
    // </div>

    function attachPickerBehavior(pickerEl) {
      const hidden     = pickerEl.querySelector('input[type="hidden"]');
      const searchBox  = pickerEl.querySelector('.vendor-search');
      const panel      = pickerEl.querySelector('.vendor-panel');
      const card       = pickerEl.closest('.card');
      const currentVid = hidden.value || card.getAttribute('data-vendor-id') || null;

      function renderOptions(filterText = '') {
        const allowed = buildAllowedOptionsForCard(currentVid);
        const ft = filterText.trim().toLowerCase();
        const filtered = allowed.filter(v => v.name.toLowerCase().includes(ft) || v.id.toLowerCase().includes(ft));
        panel.innerHTML = filtered.length
          ? filtered.map(v => `<button type="button" class="dropdown-item" data-id="${v.id}">${v.name}</button>`).join('')
          : `<div class="dropdown-item text-muted">Tidak ada hasil</div>`;
      }

      function setValue(vendorId) {
        hidden.value = vendorId || '';
        const choice = vendorChoices.find(v => v.id === vendorId);
        searchBox.value = choice ? choice.name : '';
        card.setAttribute('data-vendor-id', vendorId || '');
        panel.classList.remove('show');
        refreshAllPickers();
        recalcSummary();
      }

      function openPanel() {
        renderOptions(searchBox.value);
        panel.classList.add('show');
        panel.style.width = '100%';
        panel.style.maxHeight = '220px';
        panel.style.overflow = 'auto';
      }
      function closePanel() { panel.classList.remove('show'); }

      searchBox.addEventListener('focus', openPanel);
      searchBox.addEventListener('click', openPanel);
      searchBox.addEventListener('input', () => renderOptions(searchBox.value));
      panel.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-id]');
        if (!btn) return;
        setValue(btn.getAttribute('data-id'));
      });
      document.addEventListener('click', (e) => { if (!pickerEl.contains(e.target)) closePanel(); });

      // init tampilkan label jika sudah ada value
      if (hidden.value) {
        const choice = vendorChoices.find(v => v.id === hidden.value);
        if (choice) searchBox.value = choice.name;
      }
    }

    function refreshAllPickers() {
      vendorsContainer.querySelectorAll('.vendor-picker').forEach(p => {
        const hidden     = p.querySelector('input[type="hidden"]');
        const searchBox  = p.querySelector('.vendor-search');
        const panel      = p.querySelector('.vendor-panel');
        const card       = p.closest('.card');
        const currentVid = hidden.value || card.getAttribute('data-vendor-id') || null;

        const allowed = buildAllowedOptionsForCard(currentVid);
        const ft = (searchBox.value || '').trim().toLowerCase();
        const filtered = allowed.filter(v => v.name.toLowerCase().includes(ft) || v.id.toLowerCase().includes(ft));
        panel.innerHTML = filtered.length
          ? filtered.map(v => `<button type="button" class="dropdown-item" data-id="${v.id}">${v.name}</button>`).join('')
          : `<div class="dropdown-item text-muted">Tidak ada hasil</div>`;
      });

      const canAdd = buildAllowedOptionsForCard(null).length > 0;
      const btn = document.getElementById('btnAddVendor');
      if (btn) btn.disabled = !canAdd;
    }

    function ensureBlocksMatchSelection() {
      const selected = new Set(getSelectedVendorIds());
      vendorsContainer.querySelectorAll('.card[data-vendor-id]').forEach(card => {
        const vid = card.getAttribute('data-vendor-id');
        if (vid && !selected.has(vid)) card.remove();
      });
      refreshAllPickers();
      recalcSummary();
    }

    // ========= Builder blok vendor =========
    let vendorIdx = 0;

    function addVendorBlock(vendorId, prices = []) {
      const idx = vendorIdx++;
      const wrap = document.createElement('div');
      wrap.className = 'card border';
      wrap.setAttribute('data-vendor-id', vendorId || '');
      wrap.innerHTML = `
        <div class="card-body">
          <div class="row g-2 align-items-end">
            <div class="col-md-5">
              <label class="form-label">Vendor</label>
              <div class="vendor-picker">
                <input type="hidden" name="Vendors[${idx}].VendorId" value="${vendorId || ''}" />
                <div class="position-relative">
                  <input type="text" class="form-control vendor-search" placeholder="Cari / pilih vendor" autocomplete="off" />
                  <div class="dropdown-menu vendor-panel"></div>
                </div>
              </div>
            </div>
            <div class="col-md-7">
              <div class="hstack gap-2">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-add>+ Round</button>
                <button type="button" class="btn btn-outline-danger btn-sm ms-auto" data-del>Hapus Vendor</button>
              </div>
            </div>
          </div>
          <div class="table-responsive mt-2">
            <table class="table table-sm table-bordered mb-0">
              <thead class="table-light"><tr><th style="width:120px">Round</th><th>Harga</th><th style="width:70px"></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>`;
      vendorsContainer.appendChild(wrap);

      // aktifkan picker
      const picker = wrap.querySelector('.vendor-picker');
      attachPickerBehavior(picker);

      const tbody = wrap.querySelector('tbody');
      let round = 0;

      function addRound(value = '') {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="text-center fw-semibold">${round+1}</td>
          <td>
            <input class="form-control form-control-sm text-end"
                   name="Vendors[${idx}].Prices[${round}]"
                   value="${value}"
                   data-price />
          </td>
          <td class="text-center">
            <button type="button" class="btn btn-link text-danger p-0" data-delround>
              <i class="bi bi-x-lg"></i>
            </button>
          </td>`;
        tbody.appendChild(tr);
        tr.querySelector('[data-price]').addEventListener('input', recalcSummary);
        tr.querySelector('[data-delround]').addEventListener('click', () => { tr.remove(); recalcSummary(); });
        round++;
      }

      wrap.querySelector('[data-add]').addEventListener('click', () => addRound());
      wrap.querySelector('[data-del]').addEventListener('click', () => { wrap.remove(); ensureBlocksMatchSelection(); });

      // minimal 1 round
      addRound();

      // selesai buat blok → refresh opsi antar picker
      refreshAllPickers();
    }

    function getSelectableVendors() {
      const selected = getSelectedVendorIds();
      const existing = getOfferedVendorIds();
      return selected.filter(id => !new Set(existing).has(id));
    }

    function addVendor() {
      const candidates = getSelectableVendors();
      if (candidates.length === 0) {
        alert('Pilih vendor terlebih dahulu, atau semua vendor terpilih sudah punya blok penawaran.');
        return;
      }
      addVendorBlock(candidates[0], []);
      ensureBlocksMatchSelection();
    }

    document.getElementById('btnAddVendor').addEventListener('click', addVendor);

    // reaksi checkbox vendor
    document.querySelectorAll('input[name="SelectedVendorIds"]').forEach(cb => {
      cb.addEventListener('change', ensureBlocksMatchSelection);
    });

    // ========= Ringkasan =========
    function recalcSummary() {
      const rev = Number((document.getElementById('revenue').value || '0').replace(/\D/g,'')) || 0;
      const tb = document.querySelector('#summary tbody');
      tb.innerHTML = '';

      // untuk setiap card vendor
      vendorsContainer.querySelectorAll('.card[data-vendor-id]').forEach(card => {
        const vidHidden = card.querySelector('input[type="hidden"][name$=".VendorId"]');
        const vendorId  = vidHidden ? vidHidden.value : '';
        if (!vendorId) return;

        const vendorName = (vendorChoices.find(v => v.id === vendorId)?.name) || vendorId;
        const prices = [...card.querySelectorAll('[data-price]')]
          .map(x => parseFloat(x.value || '0')).filter(x => x > 0);
        if (!prices.length) return;

        const final = prices[prices.length - 1];
        const profit = rev - final;
        const pct = rev ? (profit / rev) * 100 : 0;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${vendorName}</td>
          <td class="text-end">${fmt(final)}</td>
          <td class="text-end">${fmt(profit)}</td>
          <td class="text-end">${pct.toFixed(2)}%</td>`;
        tb.appendChild(tr);
      });

      // highlight best vendor
      const rows = [...tb.querySelectorAll('tr')];
      if (rows.length){
        const best = rows.reduce((a,b)=>{
          const av = Number(a.children[1].innerText.replace(/\D/g,''))||0;
          const bv = Number(b.children[1].innerText.replace(/\D/g,''))||0;
          return bv < av ? b : a;
        });
        best.classList.add('table-success');
      }
    }

    // ========= Init =========
    (function init() {
      recalcHeader();
      ensureBlocksMatchSelection(); // sinkron awal (biasanya belum ada yang dicentang)
      recalcSummary();
    })();
  </script>
}
