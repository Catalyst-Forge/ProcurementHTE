@model ProcurementHTE.Web.Models.ViewModels.WorkOrderRequiredDocsVm
@{
    ViewData["Title"] = "Dokumen Work Order";
}

<div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h4 class="mb-1">Dokumen Work Order</h4>
            <small class="text-muted">@ViewBag.Wonum</small>
        </div>
        <a class="btn btn-outline-secondary" href="javascript:history.back()">
            <i class="bi bi-arrow-left me-1"></i> Kembali
        </a>
    </div>

    @* Progress Summary Card *@
    @{
        var totalDocs = Model.Items?.Count() ?? 0;
        var uploadedDocs = Model.Items?.Count(x => x.Uploaded) ?? 0;
        var requiredDocs = Model.Items?.Count(x => x.IsUploadRequired) ?? 0;
        var progressPercent = requiredDocs > 0 ? (uploadedDocs * 100 / requiredDocs) : 0;
    }

    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h6 class="mb-2">Progress Upload Dokumen</h6>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: @progressPercent%"
                             aria-valuenow="@progressPercent" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        @uploadedDocs dari @requiredDocs dokumen wajib telah diupload
                    </small>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <div class="d-flex gap-3 justify-content-md-end">
                        <div>
                            <div class="fs-4 fw-bold text-success">@uploadedDocs</div>
                            <small class="text-muted">Uploaded</small>
                        </div>
                        <div>
                            <div class="fs-4 fw-bold text-warning">@(requiredDocs - uploadedDocs)</div>
                            <small class="text-muted">Required</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table align-middle table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width:48px;" class="ps-4">#</th>
                            <th>Dokumen</th>
                            <th style="width:120px;">Status</th>
                            <th class="text-end pe-4" style="width:420px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Items == null || !Model.Items.Any())
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted py-5">
                                    <i class="bi bi-folder-x fs-1 d-block mb-2"></i>
                                    Belum ada konfigurasi dokumen.
                                </td>
                            </tr>
                        }
                        else
                        {
                            var i = 0;
                            foreach (var it in Model.Items.OrderBy(x => x.Sequence))
                            {
                                i++;
                                <tr class="@(it.IsUploadRequired && !it.Uploaded ? "table-warning bg-opacity-10" : "")">
                                    <td class="text-muted ps-4">@i</td>

                                    <td>
                                        <div class="d-flex align-items-start gap-2">
                                            @if (it.Uploaded)
                                            {
                                                <i class="bi bi-file-earmark-check-fill text-success fs-5 mt-1"></i>
                                            }
                                            else if (it.IsUploadRequired)
                                            {
                                                <i class="bi bi-file-earmark-exclamation-fill text-warning fs-5 mt-1"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-file-earmark text-secondary fs-5 mt-1"></i>
                                            }

                                            <div class="flex-grow-1">
                                                <div class="fw-semibold">@it.DocumentTypeName</div>

                                                @if (it.Uploaded && !string.IsNullOrEmpty(it.FileName))
                                                {
                                                    <div class="small text-muted mt-1">
                                                        <i class="bi bi-paperclip"></i> @it.FileName
                                                        @if (it.Size.HasValue)
                                                        {
                                                            var sizeKB = it.Size.Value / 1024.0;
                                                            var sizeMB = sizeKB / 1024.0;
                                                            var sizeStr = sizeMB >= 1 ? $"{sizeMB:F2} MB" : $"{sizeKB:F2} KB";
                                                            <span class="text-muted">• @sizeStr</span>
                                                        }
                                                    </div>
                                                }

                                                @if (!string.IsNullOrWhiteSpace(it.Note))
                                                {
                                                    <div class="small text-muted mt-1">
                                                        <i class="bi bi-info-circle"></i> @it.Note
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </td>

                                    <td>
                                        @if (it.Uploaded)
                                        {
                                            <span class="badge rounded-pill bg-success">
                                                <i class="bi bi-check-lg"></i> Uploaded
                                            </span>
                                        }
                                        else if (it.IsUploadRequired)
                                        {
                                            <span class="badge rounded-pill bg-warning text-dark">
                                                <i class="bi bi-exclamation-lg"></i> Required
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge rounded-pill bg-secondary">Optional</span>
                                        }
                                    </td>

                                    <td class="pe-4">
                                        <div class="d-flex gap-2 justify-content-end align-items-center flex-wrap">

                                            @* === Jika sudah upload: Preview / Download / Delete === *@
                                            @if (it.Uploaded && !string.IsNullOrEmpty(it.WoDocumentId))
                                            {
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-secondary btn-preview"
                                                        data-doc-id="@it.WoDocumentId"
                                                        data-doc-name="@it.DocumentTypeName"
                                                        data-file-name="@it.FileName"
                                                        title="Preview dokumen">
                                                    <i class="bi bi-eye"></i> Preview
                                                </button>

                                                <button type="button"
                                                        class="btn btn-sm btn-outline-primary btn-download"
                                                        data-doc-id="@it.WoDocumentId"
                                                        data-file-name="@it.FileName"
                                                        title="Download dokumen">
                                                    <i class="bi bi-download"></i> Download
                                                </button>

                                                <button type="button"
                                                        class="btn btn-sm btn-outline-danger btn-delete"
                                                        data-doc-id="@it.WoDocumentId"
                                                        data-doc-name="@it.DocumentTypeName"
                                                        data-file-name="@it.FileName"
                                                        data-work-order-id="@Model.WorkOrderId"
                                                        title="Hapus dokumen">
                                                    <i class="bi bi-trash"></i> Delete
                                                </button>
                                            }

                                            @* === Jika perlu upload (atau belum ada file) === *@
                                            @if (!it.Uploaded && it.IsUploadRequired)
                                            {
                                                <form class="d-inline-flex gap-2 align-items-center upload-form-@i"
                                                      asp-controller="WorkOrderDocuments"
                                                      asp-action="Upload"
                                                      method="post"
                                                      enctype="multipart/form-data"
                                                      data-row="@i">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="WorkOrderId" value="@Model.WorkOrderId" />
                                                    <input type="hidden" name="DocumentTypeId" value="@it.DocumentTypeId" />

                                                    <label class="btn btn-sm btn-outline-secondary mb-0 file-input-label" style="cursor: pointer;">
                                                        <i class="bi bi-paperclip"></i> Pilih File
                                                        <input class="d-none file-input"
                                                               type="file"
                                                               name="File"
                                                               accept="application/pdf"
                                                               required
                                                               data-row="@i" />
                                                    </label>

                                                    <span class="small text-muted file-name" data-row="@i">Belum ada file</span>

                                                    <button class="btn btn-sm btn-primary upload-btn" type="submit" disabled data-row="@i">
                                                        <i class="bi bi-upload"></i> Upload
                                                    </button>
                                                </form>
                                            }

                                            @if (!it.Uploaded && !it.IsUploadRequired)
                                            {
                                                <span class="text-muted small fst-italic">Tidak ada aksi</span>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@* PDF Preview Modal *@
<div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <div>
                    <h5 class="modal-title" id="previewModalTitle">Preview Dokumen</h5>
                    <small class="text-muted" id="previewFileName"></small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="pdfLoadingContainer" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Memuat dokumen...</p>
                </div>
                <div id="pdfErrorContainer" class="text-center py-5 d-none">
                    <i class="bi bi-exclamation-triangle-fill text-danger fs-1 mb-3"></i>
                    <p class="text-muted">Gagal memuat dokumen. Silakan coba lagi.</p>
                </div>
                <iframe id="pdfPreviewFrame"
                        style="width: 100%; height: 75vh; border: none; display: none;"
                        title="PDF Preview">
                </iframe>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" id="downloadFromPreview">
                    <i class="bi bi-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

@* Hidden form for delete action *@
<form id="deleteForm" method="post" asp-controller="WorkOrderDocuments" asp-action="Delete" style="display: none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" id="deleteDocId" />
    <input type="hidden" name="workOrderId" id="deleteWorkOrderId" />
</form>

@* SweetAlert2 CDN *@
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let currentPreviewUrl = null;
    let currentDownloadDocId = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Show success/error notifications using SweetAlert2
        @if (TempData["success"] is string successMsg)
        {
                <text>
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Berhasil!',
                    text: '@Html.Raw(System.Text.Json.JsonEncodedText.Encode(successMsg))',
                    showConfirmButton: false,
                    timer: 4000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });
                </text>
        }

        @if (TempData["error"] is string errorMsg)
        {
                <text>
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'error',
                    title: 'Error!',
                    text: '@Html.Raw(System.Text.Json.JsonEncodedText.Encode(errorMsg))',
                    showConfirmButton: false,
                    timer: 5000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });
                </text>
        }

        // Preview button handler
        document.querySelectorAll('.btn-preview').forEach(function(btn) {
            btn.addEventListener('click', async function() {
                const docId = this.dataset.docId;
                const docName = this.dataset.docName;
                const fileName = this.dataset.fileName;

                // Set modal title
                document.getElementById('previewModalTitle').textContent = docName;
                document.getElementById('previewFileName').textContent = fileName;

                // Store current doc ID for download button
                currentDownloadDocId = docId;

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
                modal.show();

                // Reset iframe and show loading
                const iframe = document.getElementById('pdfPreviewFrame');
                const loadingContainer = document.getElementById('pdfLoadingContainer');
                const errorContainer = document.getElementById('pdfErrorContainer');

                iframe.style.display = 'none';
                iframe.src = '';
                loadingContainer.classList.remove('d-none');
                errorContainer.classList.add('d-none');

                try {
                    // Fetch preview URL from API
                    const response = await fetch(`/WorkOrderDocuments/PreviewUrl/${docId}?workOrderId=@Model.WorkOrderId`);
                    const data = await response.json();

                    if (data.ok && data.url) {
                        currentPreviewUrl = data.url;
                        iframe.src = data.url;

                        // Wait for iframe to load
                        iframe.onload = function() {
                            loadingContainer.classList.add('d-none');
                            iframe.style.display = 'block';
                        };

                        // Handle iframe load error
                        iframe.onerror = function() {
                            loadingContainer.classList.add('d-none');
                            errorContainer.classList.remove('d-none');
                        };
                    } else {
                        throw new Error(data.error || 'Gagal memuat preview');
                    }
                } catch (error) {
                    console.error('Preview error:', error);
                    loadingContainer.classList.add('d-none');
                    errorContainer.classList.remove('d-none');

                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'error',
                        title: 'Gagal memuat preview',
                        text: error.message,
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                }
            });
        });

        // Download button handler (direct download)
        document.querySelectorAll('.btn-download').forEach(function(btn) {
            btn.addEventListener('click', async function() {
                const docId = this.dataset.docId;
                const fileName = this.dataset.fileName;

                // Show loading toast
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'info',
                    title: 'Memproses download...',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });

                try {
                    // Get download URL
                    const downloadUrl = `/WorkOrderDocuments/Download/${docId}?workOrderId=@Model.WorkOrderId`;

                    // Create temporary link and trigger download
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Show success toast
                    setTimeout(() => {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: 'Download dimulai',
                            text: fileName,
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true
                        });
                    }, 500);
                } catch (error) {
                    console.error('Download error:', error);
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'error',
                        title: 'Gagal mendownload',
                        text: error.message,
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                }
            });
        });

        // Download from preview modal
        document.getElementById('downloadFromPreview').addEventListener('click', function() {
            if (currentDownloadDocId) {
                const downloadBtn = document.querySelector(`.btn-download[data-doc-id="${currentDownloadDocId}"]`);
                if (downloadBtn) {
                    downloadBtn.click();
                }
            }
        });

        // File input handling
        document.querySelectorAll('.file-input').forEach(function(input) {
            input.addEventListener('change', function(e) {
                const row = this.dataset.row;
                const fileName = this.files.length > 0 ? this.files[0].name : 'Belum ada file';
                const fileNameSpan = document.querySelector(`.file-name[data-row="${row}"]`);
                const uploadBtn = document.querySelector(`.upload-btn[data-row="${row}"]`);

                if (fileNameSpan) {
                    fileNameSpan.textContent = fileName;
                    fileNameSpan.classList.toggle('text-muted', this.files.length === 0);
                    fileNameSpan.classList.toggle('text-dark', this.files.length > 0);
                }

                if (uploadBtn) {
                    uploadBtn.disabled = this.files.length === 0;
                }

                // Validate file size (max 10MB)
                if (this.files.length > 0) {
                    const file = this.files[0];
                    const maxSize = 10 * 1024 * 1024; // 10MB

                    if (file.size > maxSize) {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'warning',
                            title: 'File terlalu besar!',
                            text: 'Ukuran file maksimal 10MB',
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true
                        });
                        this.value = '';
                        fileNameSpan.textContent = 'Belum ada file';
                        fileNameSpan.classList.add('text-muted');
                        fileNameSpan.classList.remove('text-dark');
                        uploadBtn.disabled = true;
                    }
                }
            });
        });

        // Add loading state to upload forms
        document.querySelectorAll('form[enctype="multipart/form-data"]').forEach(function(form) {
            form.addEventListener('submit', function(e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Uploading...';

                    // Show loading toast
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'info',
                        title: 'Mengupload dokumen...',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });
                }
            });
        });

        // Delete button handler with SweetAlert2
        document.querySelectorAll('.btn-delete').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();

                const docId = this.dataset.docId;
                const docName = this.dataset.docName;
                const fileName = this.dataset.fileName;
                const workOrderId = this.dataset.workOrderId;

                Swal.fire({
                    title: 'Konfirmasi Hapus Dokumen',
                    html: `
                        <div class="text-start">
                            <p class="mb-2">Apakah Anda yakin ingin menghapus dokumen ini?</p>
                            <div class="alert alert-warning mb-0">
                                <strong>${docName}</strong><br>
                                <small class="text-muted">${fileName}</small>
                            </div>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="bi bi-trash me-1"></i> Ya, Hapus',
                    cancelButtonText: 'Batal',
                    reverseButtons: true,
                    focusCancel: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Set form values and submit
                        document.getElementById('deleteDocId').value = docId;
                        document.getElementById('deleteWorkOrderId').value = workOrderId;
                        document.getElementById('deleteForm').submit();
                    }
                });
            });
        });
    });
</script>

<style>
    .table > tbody > tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .file-input-label:hover {
        background-color: var(--bs-secondary-bg);
    }

    .card {
        transition: box-shadow 0.2s;
    }

    .modal-xl {
        max-width: 90%;
    }

    .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .modal-xl {
        max-width: 95%;
    }

    }
</style>