@using Microsoft.AspNetCore.Authorization
@using ProcurementHTE.Core.Common
@using ProcurementHTE.Core.Models
@using ProcurementHTE.Core.Authorization
@model PagedResult<Vendor>
@inject IAuthorizationService AuthZ
@{
    ViewData["Title"] = "Vendors";
    var canCreate = await AuthZ.AuthorizeAsync(User, Permissions.WO.Create);
    var canEdit = await AuthZ.AuthorizeAsync(User, Permissions.WO.Edit);
    var canDelete = await AuthZ.AuthorizeAsync(User, Permissions.WO.Delete);
    bool isManager = (await AuthZ.AuthorizeAsync(User, "AtLeast.Manager")).Succeeded || User.IsInRole("Admin");
    Func<string, string> BadgeClass = s => (s ?? "").ToLower() switch {
        "active" => "bg-success-subtle text-success-emphasis border border-success-subtle",
        "inactive" => "bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle",
        "suspended" => "bg-warning-subtle text-warning-emphasis border border-warning-subtle",
        _ => "bg-light text-body border"
    };
    string MaskNpwp(string npwp) {
        if (string.IsNullOrWhiteSpace(npwp))
            return "-";
        var d = new string(npwp.Where(char.IsDigit).ToArray());
        return d.Length <= 4 ? "****" : $"**** **** **** {d[^4..]}";
    };
    var currentSearch = Context.Request.Query["search"].ToString();
    var currentFields = (Context.Request.Query["fields"].ToString() ?? "VendorCode,VendorName")
        .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
        .ToHashSet(StringComparer.OrdinalIgnoreCase);
    var columns = new (string Key, string Label)[] {
        ("VendorCode","Vendor Code"),
        ("VendorName","Vendor Name"),
        ("ContactPerson","Contact Person"),
    };
    var pageSize = Model.PageSize;
}

<header class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Vendors</h1>
    <a asp-action="Create" class="btn btn-outline-primary" role="button"><i class="bi bi-plus-circle"></i> Create New</a>
</header>

<form method="get" id="filterForm" class="border rounded-3 d-flex gap-2 p-2 mb-2">
    <button type="button" class="btn btn-outline-secondary" id="btnRefresh"><i class="bi bi-arrow-clockwise"></i> Refresh</button>

    <div class="input-group w-auto">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input class="form-control" type="search" name="search" id="searchBox" placeholder="Type to search..." value="@currentSearch" />
    </div>

    <div class="dropdown ms-auto">
        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-funnel"></i> Filter
        </button>

        <div class="dropdown-menu p-3">
            <div class="mb-2 fw-semibold small text-muted">Search in columns</div>

            @foreach (var col in columns) {
                var checkedAttr = currentFields.Contains(col.Key) ? "Checked" : null;
                <div class="form-check">
                    <input type="checkbox" class="form-check-input filter-col" value="@col.Key" id="col_@col.Key" @checkedAttr />
                    <label for="col_@col.Key" class="form-check-label">@col.Label</label>
                </div>
            }
            
            <div class="d-grid mt-3">
                <button type="button" class="btn btn-primary btn-sm" id="btnApplyFilter">Apply</button>
            </div>
        </div>
    </div>

    <input type="hidden" name="fields" id="fieldsHidden" value="@string.Join(",", currentFields)" />
    <input type="hidden" name="page" id="pageHidden" value="@Model.Page" />
    <input type="hidden" name="pageSize" id="pageSizeHidden" value="@pageSize" />

    @* <button type="button" class="btn btn-outline-secondary ms-auto"><i class="bi bi-funnel me-1"></i> Filter</button> *@
</form>

<div class="table-responsive border rounded-3">
    <table class="table align-middle table-hover">
        <thead class="table-light">
            <tr>
                <th class="border-end">Vendor</th>
                <th class="d-none d-md-table-cell border-end">Location</th>
                <th class="text-center">Action</th>
            </tr>
        </thead>

        <tbody>
            @if (!Model.Items.Any() || Model == null) {
                <tr>
                    <td colspan="5" class="text-center text-muted">No vendors yet</td>
                </tr>
            } else {
                foreach (var v in Model.Items) {
                    <tr>
                        <td>
                            <div class="fw-semibold">
                                @v.VendorName
                                <span class="text-body-secondary"> · </span>
                                <a asp-action="Details" asp-route-id="@v.VendorId" class="link-primary text-decoration-none">@v.VendorCode</a>
                            </div>

                            <div class="small text-body-secondary">
                                <a href="mailto:@v.Email" class="text-decoration-none">@v.Email</a>
                                <span class="mx-1">•</span>
                                NPWP @MaskNpwp(v.NPWP)
                            </div>
                        </td>

                        <td class="d-none d-md-table-cell">
                            <span>@v.City, @v.Province</span>
                        </td>

                        <td class="text-center text-nowrap">
                            <a class="link-warning link-opacity-50-hover text-decoration-none me-2"
                               asp-action="Edit" asp-route-id="@v.VendorId" title="Edit" role="button">
                                <i class="bi bi-pencil-fill"></i>
                            </a>

                            <a class="link-info link-opacity-50-hover text-decoration-none me-2"
                               asp-action="Details" asp-route-id="@v.VendorId" title="Details" role="button">
                                <span class="visually-hidden">Edit</span>
                                <i class="bi bi-eye-fill"></i>
                            </a>

                            <form asp-action="DeleteConfirmed"
                                  asp-route-id="@v.VendorId"
                                  method="post"
                                  class="d-inline delete-form"
                                  data-name="@v.VendorName">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn link-danger link-opacity-50-hover text-decoration-none me-2 mb-1 p-0" title="Delete">
                                    <span class="visually-hidden">Delete</span>
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@await Html.PartialAsync("_Pager", Model)

@section Scripts {
    <script>
        (function () {
            const form = document.getElementById('filterForm');
            const searchBox = document.getElementById('searchBox');
            const fieldsHidden = document.getElementById('fieldsHidden');
            const pageHidden = document.getElementById('pageHidden');
            const pageSizeHidden = document.getElementById('pageSizeHidden');

            // Apply: ambil kolom tercentang, reset page ke 1, submit
            document.getElementById('btnApplyFilter').addEventListener('click', function () {
            const cols = Array.from(document.querySelectorAll('.filter-col:checked')).map(c => c.value);
            fieldsHidden.value = cols.join(',');
            pageHidden.value = 1;
            form.submit();
            });

            // Enter di search langsung submit (page reset ke 1)
            searchBox.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                pageHidden.value = 1;
                form.submit();
            }
            });

            // Refresh: hapus search & kolom, reset page ke 1 & submit
            document.getElementById('btnRefresh').addEventListener('click', function () {
            searchBox.value = '';
            fieldsHidden.value = ''; // pakai default di Controller kalau kosong
            pageHidden.value = 1;
            form.submit();
            });
        })();
        document.addEventListener("submit", async function (e) {
          const form = e.target.closest(".delete-form");
          if (!form) return;

          e.preventDefault();

          const name = form.dataset.name || "vendor ini";
          const result = await Swal.fire({
            icon: "warning",
            title: "Hapus vendor?",
            html: `Anda akan menghapus <strong>${name}</strong>.<br/>Tindakan ini tidak dapat dibatalkan.`,
            showCancelButton: true,
            confirmButtonText: "Ya, hapus",
            cancelButtonText: "Batal",
            confirmButtonColor: "#dc3545",
            cancelButtonColor: "#6c757d",
            reverseButtons: true,
            focusCancel: true
          });

          if (result.isConfirmed) form.submit();
        });

        document.addEventListener("DOMContentLoaded", () => {
          const success = '@(TempData["SuccessMessage"] ?? "")';
          const error = '@(TempData["ErrorMessage"] ?? "")';
          if (success) Swal.fire({ icon: "success", title: "Berhasil", text: success, timer: 2200, showConfirmButton: false });
          if (error) Swal.fire({ icon: "error", title: "Gagal", text: error });
        });
    </script>
}
