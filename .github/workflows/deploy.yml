name: CI & Deploy ProcurementHTE

on:
  push:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: deploy-master
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0        # WAJIB untuk NBGV (ambil full history & tags)

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: nuget-${{ runner.os }}-

      - name: Restore
        run: dotnet restore

      - name: Build & Test
        run: |
          dotnet build -c Release --no-restore
          dotnet test  -c Release --no-build --verbosity normal

      # Publish framework-dependent (.dll)
      - name: Publish (framework-dependent)
        run: |
          dotnet publish ProcurementHTE.Web/ProcurementHTE.Web.csproj \
            -c Release -o out

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: out/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    # Hardcode env di job (bisa diganti pakai repo/env variables kalau mau)
    env:
      DEPLOY_DIR: /var/www/ProcurementHTE
      APP_SERVICE: procurementhte.service

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: app
          path: drop

      - name: Sanity check & create release dir (guarded)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,APP_SERVICE,GITHUB_SHA,GITHUB_RUN_NUMBER
          script_stop: true
          script: |
            set -Eeuo pipefail

            # Fallback default bila env kosong di runner
            DEPLOY_DIR="${DEPLOY_DIR:-/var/www/ProcurementHTE}"
            APP_SERVICE="${APP_SERVICE:-procurementhte.service}"
            : "${DEPLOY_DIR:?DEPLOY_DIR is empty or not set}"
            : "${APP_SERVICE:?APP_SERVICE is empty or not set}"

            echo "[INFO] Using DEPLOY_DIR=$DEPLOY_DIR as $(whoami)"
            install -d -m 755 -o "$(whoami)" -g "$(whoami)" "$DEPLOY_DIR/releases"

            RELEASE="$DEPLOY_DIR/releases/${GITHUB_RUN_NUMBER}-${GITHUB_SHA:0:7}"
            install -d -m 755 -o "$(whoami)" -g "$(whoami)" "$RELEASE"
            echo "$RELEASE" > "$DEPLOY_DIR/.release_path"
            echo "[INFO] Prepared release dir: $RELEASE"

      - name: Upload release files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          source: "drop/*"
          target: "${{ env.DEPLOY_DIR }}/releases/${{ github.run_number }}-${{ github.sha }}"

      - name: Activate symlink & restart service (guarded)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,APP_SERVICE,GITHUB_RUN_NUMBER,GITHUB_SHA
          script_stop: true
          script: |
            set -Eeuo pipefail

            DEPLOY_DIR="${DEPLOY_DIR:-/var/www/ProcurementHTE}"
            APP_SERVICE="${APP_SERVICE:-procurementhte.service}"
            : "${DEPLOY_DIR:?DEPLOY_DIR is empty or not set}"
            : "${APP_SERVICE:?APP_SERVICE is empty or not set}"

            RELEASE="$DEPLOY_DIR/releases/${GITHUB_RUN_NUMBER}-${GITHUB_SHA:0:7}"
            test -d "$RELEASE" || { echo "[ERR] Release dir not found: $RELEASE"; exit 1; }

            ln -sfn "$RELEASE" "$DEPLOY_DIR/publish/current"
            echo "[INFO] current -> $(readlink -f "$DEPLOY_DIR/publish/current")"

            sudo systemctl daemon-reload || true
            sudo systemctl restart "$APP_SERVICE"
            sudo systemctl --no-pager --full status "$APP_SERVICE" || true

            echo "[INFO] Listening ports (expect 127.0.0.1:5159)"
            ss -tlnp | grep -E '(:5159)'

