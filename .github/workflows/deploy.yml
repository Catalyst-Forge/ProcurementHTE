name: CI & Deploy ProcurementHTE (.dll + EF SQL script)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: deploy-master
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: nuget-${{ runner.os }}-

      - name: Restore
        run: dotnet restore

      - name: Build & Test
        run: |
          dotnet build -c Release --no-restore
          dotnet test -c Release --no-build --verbosity normal

      # === EF CLI: local tool, pinned 9.*, retry + clear cache jika perlu ===
      - name: Prepare EF CLI (local tool, pinned 9.*)
        shell: bash
        run: |
          set -e
          dotnet new tool-manifest --force
          for i in 1 2 3; do
            if dotnet tool install dotnet-ef --version 9.*; then
              break
            fi
            echo "[WARN] dotnet-ef install failed (attempt $i). Clearing NuGet caches and retrying..."
            dotnet nuget locals all --clear
            rm -rf ~/.nuget/packages/dotnet-ef || true
            sleep 2
          done
          dotnet tool list

      - name: Publish (framework-dependent) + generate Migrations.sql (idempotent)
        shell: bash
        env:
          # Connection string untuk design-time factory (dibaca oleh AppDbContextFactory)
          EF_CONNECTION: ${{ secrets.DB_CONNECTION }}
        run: |
          # publish web (hasil .dll + deps di folder 'out')
          dotnet publish ProcurementHTE.Web/ProcurementHTE.Web.csproj -c Release -o out

          # generate idempotent migration script -> out/Migrations.sql
          # menggunakan project Infrastructure sebagai migrations assembly
          dotnet tool run dotnet-ef migrations script --idempotent \
            -p ProcurementHTE.Infrastructure \
            --configuration Release \
            -o out/Migrations.sql

          ls -la out

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: out/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    env:
      # ---- Server paths & service (PAKAI SECRETS) ----
      DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}          # contoh: /var/www/ProcurementHTE
      APP_SERVICE: ${{ secrets.APP_SERVICE }}        # contoh: procurementhte.service

      # ---- DB creds (semua dari Secrets) ----
      DB_HOST: ${{ secrets.DB_HOST }}                # IP/host SQL Server
      DB_PORT: ${{ secrets.DB_PORT }}                # isi di secrets (biar tidak kosong)
      DB_USER: ${{ secrets.DB_USER }}                # sa / user lain
      DB_PASS: ${{ secrets.DB_PASS }}                # password
      DB_NAME: ${{ secrets.DB_NAME }}                # ProcurementHTE
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app
          path: artifact

      - name: Compute release name (runNumber-sha7)
        shell: bash
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          echo "RELEASE_NAME=${GITHUB_RUN_NUMBER}-${SHORT_SHA}" >> $GITHUB_ENV
          echo "RDIR=/releases/${GITHUB_RUN_NUMBER}-${SHORT_SHA}" >> $GITHUB_ENV
          echo "Done: $RELEASE_NAME"

      - name: Sanity check deploy env
        shell: bash
        run: |
          for v in DEPLOY_DIR APP_SERVICE DB_HOST DB_NAME; do
            if [ -z "${!v}" ]; then echo "::error::$v is empty"; exit 1; fi
          done
          # fallback default untuk DB_PORT
          if [ -z "${DB_PORT}" ]; then echo "DB_PORT not set, defaulting to 1433"; echo "DB_PORT=1433" >> $GITHUB_ENV; fi
          echo "[OK] Required env present"

      - name: Create release dir on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,RELEASE_NAME
          script_stop: true
          script: |
            set -Eeuo pipefail
            : "${DEPLOY_DIR:?DEPLOY_DIR is empty or not set}"
            : "${RELEASE_NAME:?RELEASE_NAME is empty or not set}"

            echo "[INFO] DEPLOY_DIR=$DEPLOY_DIR, RELEASE_NAME=$RELEASE_NAME"
            install -d -m 755 -o "$(whoami)" -g "$(whoami)" "$DEPLOY_DIR"
            install -d -m 755 -o "$(whoami)" -g "$(whoami)" "$DEPLOY_DIR/releases"
            install -d -m 755 -o "$(whoami)" -g "$(whoami)" "$DEPLOY_DIR/publish"

            RELEASE="$DEPLOY_DIR/releases/$RELEASE_NAME"
            install -d -m 755 -o "$(whoami)" -g "$(whoami)" "$RELEASE"
            echo "$RELEASE" > "$DEPLOY_DIR/.release_path"
            echo "[INFO] Release path: $RELEASE"

      - name: Upload release files (put DLL + Migrations.sql at release root)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          source: "artifact/*"
          target: "${{ env.DEPLOY_DIR }}/releases/${{ env.RELEASE_NAME }}"

      - name: Verify release contents (debug)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,RELEASE_NAME
          script: |
            set -Eeuo pipefail
            RELEASE="$DEPLOY_DIR/releases/$RELEASE_NAME"
            echo "[INFO] ls -la $RELEASE"
            ls -la "$RELEASE"
            test -f "$RELEASE/ProcurementHTE.Web.dll" || { echo "[ERR] DLL not found in $RELEASE"; exit 1; }
            if [ -f "$RELEASE/Migrations.sql" ]; then
              echo "[OK] Found Migrations.sql"
            else
              echo "[WARN] Migrations.sql not found (mungkin tidak ada perubahan DB?)"
            fi

      - name: Apply DB migrations (idempotent SQL)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,RELEASE_NAME,DB_HOST,DB_PORT,DB_USER,DB_PASS,DB_NAME
          script_stop: true
          script: |
            set -Eeuo pipefail
            RELEASE="$DEPLOY_DIR/releases/$RELEASE_NAME"
            MIG="$RELEASE/Migrations.sql"

            if [ ! -s "$MIG" ]; then
              echo "[INFO] No migrations to apply (file missing or empty)"; exit 0
            fi

            # default DB_PORT kalau kosong
            DB_PORT="${DB_PORT:-1433}"

            echo "[INFO] Applying migrations using sqlcmd to ${DB_HOST},${DB_PORT}/${DB_NAME} ..."

            run_sqlcmd_host () {
              local BIN=""
              if command -v sqlcmd >/dev/null 2>&1; then BIN="sqlcmd"; fi
              if [ -z "$BIN" ] && [ -x /opt/mssql-tools18/bin/sqlcmd ]; then BIN="/opt/mssql-tools18/bin/sqlcmd"; fi
              if [ -z "$BIN" ] && [ -x /opt/mssql-tools/bin/sqlcmd ]; then BIN="/opt/mssql-tools/bin/sqlcmd"; fi
              [ -n "$BIN" ] || return 1
              echo "[INFO] Host $BIN found, applying..."
              "$BIN" -S "${DB_HOST},${DB_PORT}" -U "${DB_USER}" -P "${DB_PASS}" -d "${DB_NAME}" -C -b -i "$MIG"
            }

            run_sqlcmd_docker () {
              CID="$(docker ps --format '{{.ID}} {{.Image}}' | grep -Ei 'mssql|sqlserver' | awk '{print $1}' | head -n1 || true)"
              [ -n "$CID" ] || return 1
              echo "[INFO] Using docker exec on container $CID"
              docker cp "$MIG" "$CID:/tmp/mig.sql"
              if docker exec "$CID" bash -lc 'test -x /opt/mssql-tools18/bin/sqlcmd'; then
                docker exec "$CID" /opt/mssql-tools18/bin/sqlcmd -S "127.0.0.1,1433" -U "${DB_USER}" -P "${DB_PASS}" -d "${DB_NAME}" -C -b -i /tmp/mig.sql
              else
                docker exec "$CID" /opt/mssql-tools/bin/sqlcmd    -S "127.0.0.1,1433" -U "${DB_USER}" -P "${DB_PASS}" -d "${DB_NAME}" -C -b -i /tmp/mig.sql
              fi
            }

            if ! run_sqlcmd_host; then
              echo "[INFO] Host sqlcmd not found; trying docker..."
              run_sqlcmd_docker || { echo "[ERR] sqlcmd not available on host or docker"; exit 1; }
            fi
            echo "[OK] DB migrations applied."

      - name: Activate & restart service
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,APP_SERVICE,RELEASE_NAME
          script_stop: true
          script: |
            set -Eeuo pipefail
            : "${DEPLOY_DIR:?DEPLOY_DIR is empty or not set}"
            : "${APP_SERVICE:?APP_SERVICE is empty or not set}"
            : "${RELEASE_NAME:?RELEASE_NAME is empty or not set}"

            RELEASE="$DEPLOY_DIR/releases/$RELEASE_NAME"
            test -f "$RELEASE/ProcurementHTE.Web.dll" || { echo "[ERR] Missing DLL in $RELEASE"; exit 1; }

            ln -sfn "$RELEASE" "$DEPLOY_DIR/publish/current"
            echo "[INFO] current -> $(readlink -f "$DEPLOY_DIR/publish/current")"

            sudo systemctl daemon-reload || true
            sudo systemctl restart "$APP_SERVICE"
            sudo systemctl --no-pager --full status "$APP_SERVICE" || true

      - name: Smoke check (Kestrel & curl)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR
          script: |
            set -Eeuo pipefail
            ss -tlnp | grep -E '(:5159)' || (echo "[ERR] Kestrel not listening on 5159"; exit 1)
            curl -sS -I -H 'Host: procurementhte.dev' -H 'X-Forwarded-Proto: https' http://127.0.0.1:5159/ | head -n1 || true
