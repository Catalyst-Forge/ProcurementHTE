name: CI & Deploy ProcurementHTE (.dll)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: deploy-master
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: nuget-${{ runner.os }}-

      - name: Restore
        run: dotnet restore

      - name: Build & Test
        run: |
          dotnet build -c Release --no-restore
          dotnet test  -c Release --no-build --verbosity normal

      - name: Publish (framework-dependent)
        run: |
          dotnet publish ProcurementHTE.Web/ProcurementHTE.Web.csproj -c Release -o out
          # Guard: pastikan DLL ada
          test -f out/ProcurementHTE.Web.dll

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: out/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: app
          path: drop

      - name: Compute names & defaults
        shell: bash
        run: |
          echo "DEPLOY_DIR=${DEPLOY_DIR:-/var/www/ProcurementHTE}" >> $GITHUB_ENV
          echo "APP_SERVICE=${APP_SERVICE:-procurementhte.service}" >> $GITHUB_ENV
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "RELEASE_NAME=${GITHUB_RUN_NUMBER}-${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "[LOCAL] Artifact list:" && ls -la drop | sed -n '1,200p'

      - name: Create release dir (server)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,RELEASE_NAME
          script_stop: true
          script: |
            set -Eeuo pipefail
            : "${DEPLOY_DIR:?}"; : "${RELEASE_NAME:?}"
            echo "[INFO] DEPLOY_DIR=$DEPLOY_DIR RELEASE_NAME=$RELEASE_NAME"
            install -d -m 755 "$DEPLOY_DIR" "$DEPLOY_DIR/releases" "$DEPLOY_DIR/publish"
            install -d -m 755 "$DEPLOY_DIR/releases/$RELEASE_NAME"
            echo "$DEPLOY_DIR/releases/$RELEASE_NAME" > "$DEPLOY_DIR/.release_path"
            echo "[INFO] Release path: $(cat "$DEPLOY_DIR/.release_path")"

      - name: Upload release files (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          source: "drop/**"
          target: "${{ env.DEPLOY_DIR }}/releases/${{ env.RELEASE_NAME }}"
          # NOTE: kita sengaja tidak pakai strip_components agar kompatibel lintas versi

      # ðŸ”§ Flatten jika scp menaruh isi ke subfolder "drop/"
      - name: Flatten release folder (server)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,RELEASE_NAME
          script_stop: true
          script: |
            set -Eeuo pipefail
            R="$DEPLOY_DIR/releases/$RELEASE_NAME"
            if [ -d "$R/drop" ]; then
              echo "[INFO] Found nested '$R/drop' â€” flattening to '$R'"
              shopt -s dotglob nullglob
              mv "$R/drop"/* "$R"/ || true
              rmdir "$R/drop" || true
            fi
            echo "[INFO] Contents after flatten:"
            ls -la "$R" | sed -n '1,200p'

      - name: Verify release contents (server)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,RELEASE_NAME
          script: |
            set -Eeuo pipefail
            R="$DEPLOY_DIR/releases/$RELEASE_NAME"
            test -f "$R/ProcurementHTE.Web.dll" || {
              echo "[ERR] DLL not found in $R"
              find "$R" -maxdepth 2 -name 'ProcurementHTE.Web.dll' -print
              exit 1
            }

      - name: Activate & restart service
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,APP_SERVICE,RELEASE_NAME
          script_stop: true
          script: |
            set -Eeuo pipefail
            : "${DEPLOY_DIR:?}"; : "${APP_SERVICE:?}"; : "${RELEASE_NAME:?}"
            R="$DEPLOY_DIR/releases/$RELEASE_NAME"

            ln -sfn "$R" "$DEPLOY_DIR/publish/current"
            echo "[INFO] current -> $(readlink -f "$DEPLOY_DIR/publish/current")"

            sudo -n systemctl daemon-reload || true
            sudo -n systemctl restart "$APP_SERVICE"
            sudo -n systemctl --no-pager --full status "$APP_SERVICE" || true

            echo "[INFO] Listening ports (expect 127.0.0.1:5159)"
            ss -tlnp | grep -E '(:5159)' || true
