name: CI & Deploy ProcurementHTE (migrate-first)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: deploy-master
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: nuget-${{ runner.os }}-

      - name: Restore
        run: dotnet restore

      - name: Build & Test
        run: |
          dotnet build -c Release --no-restore
          dotnet test -c Release --no-build --verbosity normal

      - name: Install dotnet-ef (global)
        run: dotnet tool install --global dotnet-ef

      - name: Publish (framework-dependent)
        env:
          PATH: ${{ env.PATH }}:$HOME/.dotnet/tools
        run: |
          # Publish app
          dotnet publish ProcurementHTE.Web/ProcurementHTE.Web.csproj \
            -c Release -o out

          # Generate idempotent migration script
          export PATH="$HOME/.dotnet/tools:$PATH"
          dotnet ef migrations script --idempotent \
            -p ProcurementHTE.Infrastructure \
            -s ProcurementHTE.Web \
            -o out/Migrations.sql

          # Debug list
          ls -la out/ | sed -n '1,200p'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: out/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    env:
      DEPLOY_DIR: ${{ vars.DEPLOY_DIR }}        # /var/www/ProcurementHTE
      APP_SERVICE: ${{ vars.APP_SERVICE }}      # procurementhte.service
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app
          path: drop

      - name: Compute release name
        shell: bash
        run: |
          echo "RELEASE_NAME=${GITHUB_RUN_NUMBER}-${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          echo "SHORT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV

      - name: Create release dir on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,RELEASE_NAME
          script_stop: true
          script: |
            set -Eeuo pipefail
            : "${DEPLOY_DIR:?DEPLOY_DIR is empty or not set}"
            : "${RELEASE_NAME:?RELEASE_NAME is empty or not set}"

            echo "[INFO] DEPLOY_DIR=$DEPLOY_DIR, RELEASE_NAME=$RELEASE_NAME"
            install -d -m 755 -o "$(whoami)" -g "$(whoami)" "$DEPLOY_DIR"
            install -d -m 755 -o "$(whoami)" -g "$(whoami)" "$DEPLOY_DIR/releases"
            install -d -m 755 -o "$(whoami)" -g "$(whoami)" "$DEPLOY_DIR/publish"

            RELEASE="$DEPLOY_DIR/releases/$RELEASE_NAME"
            install -d -m 755 -o "$(whoami)" -g "$(whoami)" "$RELEASE"
            echo "$RELEASE" > "$DEPLOY_DIR/.release_path"
            echo "[INFO] Release path: $RELEASE"

      - name: Upload release files (flat to release root)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          source: "drop/*"   # <— penting: * supaya isinya langsung ke root release
          target: "${{ env.DEPLOY_DIR }}/releases/${{ env.RELEASE_NAME }}"

      - name: Verify release contents (debug)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,RELEASE_NAME
          script: |
            set -Eeuo pipefail
            RELEASE="$DEPLOY_DIR/releases/$RELEASE_NAME"
            echo "[INFO] ls -la $RELEASE"
            ls -la "$RELEASE" | sed -n '1,200p'
            test -f "$RELEASE/ProcurementHTE.Web.dll" || { echo "[ERR] DLL not found in $RELEASE"; exit 1; }
            test -f "$RELEASE/Migrations.sql" || { echo "[WARN] Migrations.sql not found — will skip DB migration"; }

      - name: Apply DB migrations (via docker mssql-tools)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,RELEASE_NAME,MSSQL_SA_PASSWORD
          script_stop: true
          script: |
            set -Eeuo pipefail
            RELEASE="$DEPLOY_DIR/releases/$RELEASE_NAME"

            if [ ! -f "$RELEASE/Migrations.sql" ]; then
              echo "[INFO] No Migrations.sql — skipping DB migration"
              exit 0
            fi

            if ! command -v docker >/dev/null 2>&1; then
              echo "[WARN] docker not found — skipping DB migration"
              exit 0
            fi

            echo "[INFO] Pull mssql-tools (if needed)"
            docker image inspect mcr.microsoft.com/mssql-tools:latest >/dev/null 2>&1 || \
              docker pull mcr.microsoft.com/mssql-tools:latest

            echo "[INFO] Applying migrations to DB ProcurementHTE on localhost:1433"
            docker run --rm -i --network host mcr.microsoft.com/mssql-tools:latest \
              /opt/mssql-tools/bin/sqlcmd \
                -S 127.0.0.1,1433 \
                -U SA -P "${MSSQL_SA_PASSWORD}" \
                -d ProcurementHTE \
                -b -i /dev/stdin < "$RELEASE/Migrations.sql"

            echo "[INFO] Migration completed"

      - name: Activate & restart service
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          envs: DEPLOY_DIR,APP_SERVICE,RELEASE_NAME
          script_stop: true
          script: |
            set -Eeuo pipefail
            : "${APP_SERVICE:?APP_SERVICE is empty or not set}"
            RELEASE="$DEPLOY_DIR/releases/$RELEASE_NAME"

            test -f "$RELEASE/ProcurementHTE.Web.dll" || { echo "[ERR] DLL not found in $RELEASE"; exit 1; }

            ln -sfn "$RELEASE" "$DEPLOY_DIR/publish/current"
            echo "[INFO] current -> $(readlink -f "$DEPLOY_DIR/publish/current")"

            sudo systemctl daemon-reload || true
            sudo systemctl restart "$APP_SERVICE"
            sudo systemctl --no-pager --full status "$APP_SERVICE" || true

            echo "[INFO] Listening ports (expect 127.0.0.1:5159)"
            ss -tlnp | grep -E '(:5159)' || true

            echo "[INFO] Kestrel quick healthcheck"
            curl -I -sS -H 'Host: procurementhte.dev' -H 'X-Forwarded-Proto: https' http://127.0.0.1:5159/ || true
